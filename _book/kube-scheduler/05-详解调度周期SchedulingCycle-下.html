
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>详解调度周期SchedulingCycle(下) · Kubernetes Learning</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="lts0609">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-pageview-count/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-treeview/style.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-auto-scroll-table/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-okaidia.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="06-详解绑定周期BindingCycle.html" />
    
    
    <link rel="prev" href="04-详解调度周期SchedulingCycle-上.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Kubernetes源码学习
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="./">
            
                <a href="./">
            
                    
                    Scheduler
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="01-Scheduler创建流程与调度队列.html">
            
                <a href="01-Scheduler创建流程与调度队列.html">
            
                    
                    Scheduler创建流程与调度队列
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="02-调度器缓存Cache的实现.html">
            
                <a href="02-调度器缓存Cache的实现.html">
            
                    
                    调度器缓存Cache的实现
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="03-Framework框架和调度流程.html">
            
                <a href="03-Framework框架和调度流程.html">
            
                    
                    Framework框架和调度流程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="04-详解调度周期SchedulingCycle-上.html">
            
                <a href="04-详解调度周期SchedulingCycle-上.html">
            
                    
                    详解调度周期SchedulingCycle(上)
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.5" data-path="05-详解调度周期SchedulingCycle-下.html">
            
                <a href="05-详解调度周期SchedulingCycle-下.html">
            
                    
                    详解调度周期SchedulingCycle(下)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="06-详解绑定周期BindingCycle.html">
            
                <a href="06-详解绑定周期BindingCycle.html">
            
                    
                    详解绑定周期BindingCycle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="07-失败处理与抢占调度Preemption.html">
            
                <a href="07-失败处理与抢占调度Preemption.html">
            
                    
                    失败处理与抢占调度Preemption
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="08-调度器扩展与实践.html">
            
                <a href="08-调度器扩展与实践.html">
            
                    
                    调度器扩展与实践
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../kube-controller-manager/">
            
                <a href="../kube-controller-manager/">
            
                    
                    Controller Manager
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../kube-controller-manager/01-ControllerManager创建流程.html">
            
                <a href="../kube-controller-manager/01-ControllerManager创建流程.html">
            
                    
                    ControllerManager创建流程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../kube-controller-manager/02-DeploymentController原理详解.html">
            
                <a href="../kube-controller-manager/02-DeploymentController原理详解.html">
            
                    
                    DeploymentController原理详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../kube-controller-manager/03-ReplicaSetController原理详解.html">
            
                <a href="../kube-controller-manager/03-ReplicaSetController原理详解.html">
            
                    
                    ReplicaSetController原理详解
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >详解调度周期SchedulingCycle(下)</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#&#x8BE6;&#x89E3;&#x8C03;&#x5EA6;&#x5468;&#x671F;schedulingcycle&#x4E0B;"><b> </b>&#x8BE6;&#x89E3;&#x8C03;&#x5EA6;&#x5468;&#x671F;SchedulingCycle(&#x4E0B;)</a></li><ul><li><span class="title-icon "></span><a href="#&#x8C03;&#x5EA6;&#x5468;&#x671F;"><b>1. </b>&#x8C03;&#x5EA6;&#x5468;&#x671F;</a></li><li><span class="title-icon "></span><a href="#priorities&#x9636;&#x6BB5;"><b>2. </b>Priorities&#x9636;&#x6BB5;</a></li><ul><li><span class="title-icon "></span><a href="#score&#x6269;&#x5C55;&#x70B9;&#x4E0E;normalizescore&#x8BC4;&#x5206;&#x5F52;&#x4E00;&#x5316;"><b>2.1. </b>Score&#x6269;&#x5C55;&#x70B9;&#x4E0E;NormalizeScore&#x8BC4;&#x5206;&#x5F52;&#x4E00;&#x5316;</a></li><li><span class="title-icon "></span><a href="#normalizescore&#x63D2;&#x4EF6;"><b>2.2. </b>NormalizeScore&#x63D2;&#x4EF6;</a></li><li><span class="title-icon "></span><a href="#selecthost"><b>2.3. </b>SelectHost</a></li></ul><li><span class="title-icon "></span><a href="#assume&#x9636;&#x6BB5;"><b>3. </b>Assume&#x9636;&#x6BB5;</a></li><li><span class="title-icon "></span><a href="#reserve&#x6269;&#x5C55;&#x70B9;"><b>4. </b>Reserve&#x6269;&#x5C55;&#x70B9;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5931;&#x8D25;&#x540E;&#x7684;&#x72B6;&#x6001;&#x56DE;&#x6EDA;"><b>4.1. </b>&#x5931;&#x8D25;&#x540E;&#x7684;&#x72B6;&#x6001;&#x56DE;&#x6EDA;</a></li></ul><li><span class="title-icon "></span><a href="#permit&#x6269;&#x5C55;&#x70B9;"><b>5. </b>Permit&#x6269;&#x5C55;&#x70B9;</a></li><ul><li><span class="title-icon "></span><a href="#permit&#x6269;&#x5C55;&#x70B9;&#x7684;&#x5EF6;&#x4F38;"><b>5.1. </b>Permit&#x6269;&#x5C55;&#x70B9;&#x7684;&#x5EF6;&#x4F38;</a></li></ul></ul></ul></div><a href="#&#x8BE6;&#x89E3;&#x8C03;&#x5EA6;&#x5468;&#x671F;schedulingcycle&#x4E0B;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><div class="treeview__container"><ul>
<li><div><a href="#&#x8C03;&#x5EA6;&#x5468;&#x671F;">&#x8C03;&#x5EA6;&#x5468;&#x671F;</a><i></i></div></li>
<li><div><a href="#priorities&#x9636;&#x6BB5;">Priorities&#x9636;&#x6BB5;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#score&#x6269;&#x5C55;&#x70B9;&#x4E0E;normalizescore&#x8BC4;&#x5206;&#x5F52;&#x4E00;&#x5316;">Score&#x6269;&#x5C55;&#x70B9;&#x4E0E;NormalizeScore&#x8BC4;&#x5206;&#x5F52;&#x4E00;&#x5316;</a><i></i></div></li>
<li><div><a href="#normalizescore&#x63D2;&#x4EF6;">NormalizeScore&#x63D2;&#x4EF6;</a><i></i></div></li>
<li><div><a href="#selecthost">SelectHost</a><i></i></div></li>
</ul></li>
<li><div><a href="#assume&#x9636;&#x6BB5;">Assume&#x9636;&#x6BB5;</a><i></i></div></li>
<li><div><a href="#reserve&#x6269;&#x5C55;&#x70B9;">Reserve&#x6269;&#x5C55;&#x70B9;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#&#x5931;&#x8D25;&#x540E;&#x7684;&#x72B6;&#x6001;&#x56DE;&#x6EDA;">&#x5931;&#x8D25;&#x540E;&#x7684;&#x72B6;&#x6001;&#x56DE;&#x6EDA;</a><i></i></div></li>
</ul></li>
<li><div><a href="#permit&#x6269;&#x5C55;&#x70B9;">Permit&#x6269;&#x5C55;&#x70B9;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#permit&#x6269;&#x5C55;&#x70B9;&#x7684;&#x5EF6;&#x4F38;">Permit&#x6269;&#x5C55;&#x70B9;&#x7684;&#x5EF6;&#x4F38;</a><i></i></div></li>
</ul></li>
</ul>
</div>

<h1 id="&#x8BE6;&#x89E3;&#x8C03;&#x5EA6;&#x5468;&#x671F;schedulingcycle&#x4E0B;"><a name="&#x8BE6;&#x89E3;&#x8C03;&#x5EA6;&#x5468;&#x671F;schedulingcycle&#x4E0B;" class="anchor-navigation-ex-anchor" href="#&#x8BE6;&#x89E3;&#x8C03;&#x5EA6;&#x5468;&#x671F;schedulingcycle&#x4E0B;"><i class="fa fa-link" aria-hidden="true"></i></a> &#x8BE6;&#x89E3;&#x8C03;&#x5EA6;&#x5468;&#x671F;SchedulingCycle(&#x4E0B;)</h1>
<h2 id="&#x8C03;&#x5EA6;&#x5468;&#x671F;"><a name="&#x8C03;&#x5EA6;&#x5468;&#x671F;" class="anchor-navigation-ex-anchor" href="#&#x8C03;&#x5EA6;&#x5468;&#x671F;"><i class="fa fa-link" aria-hidden="true"></i></a>1. &#x8C03;&#x5EA6;&#x5468;&#x671F;</h2>
<p>&#x5728;&#x4E0A;&#x7BC7;&#x4E2D;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x4E86;&#x8C03;&#x5EA6;&#x5468;&#x671F;&#x7684;&#x4E0A;&#x534A;&#x6BB5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<code>Predicates</code>&#x8FC7;&#x6EE4;&#x9636;&#x6BB5;&#xFF0C;&#x5728;&#x5176;&#x8FC7;&#x7A0B;&#x4E2D;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x5BF9;&#x8C61;<code>feasibleNodes</code>&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x4E2A;<code>NodeInfo</code>&#x7C7B;&#x578B;&#x7684;&#x5207;&#x7247;&#xFF0C;&#x4FDD;&#x5B58;&#x4E86;&#x5728;&#x6761;&#x4EF6;&#x8FC7;&#x6EE4;&#x540E;&#x7B26;&#x5408;Pod&#x8C03;&#x5EA6;&#x8981;&#x6C42;&#x7684;&#x8282;&#x70B9;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x56DE;&#x5230;<code>Predicates</code>&#x7ED3;&#x675F;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<code>schedulePod()</code>&#x65B9;&#x6CD5;&#x4E2D;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sched <span class="token operator">*</span>Scheduler<span class="token punctuation">)</span> <span class="token function">schedulePod</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> fwk framework<span class="token punctuation">.</span>Framework<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token punctuation">(</span>result ScheduleResult<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token comment">// Predicates&#x9636;&#x6BB5; &#x8FD4;&#x56DE;&#x9884;&#x9009;Node&#x548C;&#x8BCA;&#x65AD;&#x7ED3;&#x679C;</span>
    feasibleNodes<span class="token punctuation">,</span> diagnosis<span class="token punctuation">,</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">findNodesThatFitPod</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">)</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token comment">// Case1:&#x8282;&#x70B9;&#x5217;&#x8868;&#x4E3A;&#x7A7A; &#x8FD4;&#x56DE;&#x5931;&#x8D25;</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>feasibleNodes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x4E0A;&#x5C42;&#x51FD;&#x6570;&#x53EA;&#x4F1A;&#x5173;&#x6CE8;err&#x662F;&#x5426;&#x4E3A;&#x7A7A; result&#x672A;&#x88AB;&#x8D4B;&#x503C;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token operator">&amp;</span>framework<span class="token punctuation">.</span>FitError<span class="token punctuation">{</span>
            Pod<span class="token punctuation">:</span>         pod<span class="token punctuation">,</span>
            NumAllNodes<span class="token punctuation">:</span> sched<span class="token punctuation">.</span>nodeInfoSnapshot<span class="token punctuation">.</span><span class="token function">NumNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Diagnosis<span class="token punctuation">:</span>   diagnosis<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Case2:&#x5217;&#x8868;&#x957F;&#x5EA6;&#x4E3A;1 &#x4E0D;&#x9700;&#x8981;Priorities&#x9636;&#x6BB5; &#x76F4;&#x63A5;&#x8D70;&#x540E;&#x7EED;&#x6D41;&#x7A0B;</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>feasibleNodes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x5728;Predicates&#x9636;&#x6BB5;&#x6210;&#x529F;&#x65F6;&#x4F1A;&#x6839;&#x636E;feasibleNodes&#x586B;&#x5145;result&#x5BF9;&#x8C61;</span>
        <span class="token keyword">return</span> ScheduleResult<span class="token punctuation">{</span>
            SuggestedHost<span class="token punctuation">:</span>  feasibleNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
            EvaluatedNodes<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">+</span> diagnosis<span class="token punctuation">.</span>NodeToStatus<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            FeasibleNodes<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Case3:&#x5217;&#x8868;&#x957F;&#x5EA6;&gt;1 &#x9700;&#x8981;Priorities&#x9636;&#x6BB5;&#x9009;&#x51FA;&#x6700;&#x5408;&#x9002;&#x7684;&#x8282;&#x70B9;&#x518D;&#x8FD4;&#x56DE;</span>
    priorityList<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">prioritizeNodes</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sched<span class="token punctuation">.</span>Extenders<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> feasibleNodes<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> result<span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    host<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">selectHost</span><span class="token punctuation">(</span>priorityList<span class="token punctuation">,</span> numberOfHighestScoredNodesToReport<span class="token punctuation">)</span>
    trace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;Prioritizing done&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> ScheduleResult<span class="token punctuation">{</span>
        SuggestedHost<span class="token punctuation">:</span>  host<span class="token punctuation">,</span>
        EvaluatedNodes<span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>feasibleNodes<span class="token punctuation">)</span> <span class="token operator">+</span> diagnosis<span class="token punctuation">.</span>NodeToStatus<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        FeasibleNodes<span class="token punctuation">:</span>  <span class="token function">len</span><span class="token punctuation">(</span>feasibleNodes<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<h2 id="priorities&#x9636;&#x6BB5;"><a name="priorities&#x9636;&#x6BB5;" class="anchor-navigation-ex-anchor" href="#priorities&#x9636;&#x6BB5;"><i class="fa fa-link" aria-hidden="true"></i></a>2. Priorities&#x9636;&#x6BB5;</h2>
<p><code>Priorities</code>&#x9636;&#x6BB5;&#x7684;&#x5165;&#x53E3;&#x51FD;&#x6570;&#x662F;<code>prioritizeNodes()</code>&#xFF0C;&#x5BF9;&#x8C03;&#x5EA6;&#x6D41;&#x7A0B;&#x6709;&#x8FC7;&#x57FA;&#x672C;&#x4E86;&#x89E3;&#x7684;&#x4E00;&#x5B9A;&#x90FD;&#x77E5;&#x9053;Pod&#x7684;&#x8C03;&#x5EA6;&#x6709;<code>&#x9884;&#x9009;</code>&#x548C;<code>&#x4F18;&#x9009;</code>&#x4E24;&#x4E2A;&#x9636;&#x6BB5;&#xFF0C;&#x5F88;&#x660E;&#x663E;&#x5728;&#x8FD9;&#x4E2A;&#x9636;&#x6BB5;&#x8981;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x5C31;&#x662F;&#x5BF9;&#x4E0A;&#x4E00;&#x6B65;&#x4E2D;&#x8FC7;&#x6EE4;&#x51FA;&#x6765;&#x7684;&#x8282;&#x70B9;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF0C;&#x7136;&#x540E;&#x9009;&#x62E9;&#x6700;&#x5408;&#x9002;&#x7684;&#x4E00;&#x4E2A;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">prioritizeNodes</span><span class="token punctuation">(</span>
    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
    extenders <span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>Extender<span class="token punctuation">,</span>
    fwk framework<span class="token punctuation">.</span>Framework<span class="token punctuation">,</span>
    state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span>
    pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>
    nodes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>extenders<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fwk<span class="token punctuation">.</span><span class="token function">HasScorePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> nodes <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">{</span>
                Name<span class="token punctuation">:</span>       nodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
                TotalScore<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Run PreScore plugins.</span>
    preScoreStatus <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">RunPreScorePlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>preScoreStatus<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> preScoreStatus<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Run the Score plugins.</span>
    nodesScores<span class="token punctuation">,</span> scoreStatus <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">RunScorePlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>scoreStatus<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> scoreStatus<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Additional details logged at level 10 if enabled.</span>
    loggerVTen <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> loggerVTen<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> nodeScore <span class="token operator">:=</span> <span class="token keyword">range</span> nodesScores <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pluginScore <span class="token operator">:=</span> <span class="token keyword">range</span> nodeScore<span class="token punctuation">.</span>Scores <span class="token punctuation">{</span>
                loggerVTen<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Plugin scored node for pod&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;plugin&quot;</span><span class="token punctuation">,</span> pluginScore<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> nodeScore<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">&quot;score&quot;</span><span class="token punctuation">,</span> pluginScore<span class="token punctuation">.</span>Score<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>extenders<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nodes <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// allNodeExtendersScores has all extenders scores for all nodes.</span>
        <span class="token comment">// It is keyed with node name.</span>
        allNodeExtendersScores <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>Mutex
        <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> extenders <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>extenders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">IsInterested</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>extIndex <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                metrics<span class="token punctuation">.</span>Goroutines<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>PrioritizingExtender<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    metrics<span class="token punctuation">.</span>Goroutines<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>PrioritizingExtender<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Dec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                prioritizedList<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> err <span class="token operator">:=</span> extenders<span class="token punctuation">[</span>extIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Prioritize</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities</span>
                    logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to run extender&apos;s priority function. No score given by this extender.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;extender&quot;</span><span class="token punctuation">,</span> extenders<span class="token punctuation">[</span>extIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token operator">*</span>prioritizedList <span class="token punctuation">{</span>
                    nodename <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>prioritizedList<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Host
                    score <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>prioritizedList<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score
                    <span class="token keyword">if</span> loggerVTen<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        loggerVTen<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Extender scored node for pod&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;extender&quot;</span><span class="token punctuation">,</span> extenders<span class="token punctuation">[</span>extIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> nodename<span class="token punctuation">,</span> <span class="token string">&quot;score&quot;</span><span class="token punctuation">,</span> score<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// MaxExtenderPriority may diverge from the max priority used in the scheduler and defined by MaxNodeScore,</span>
                    <span class="token comment">// therefore we need to scale the score returned by extenders to the score range used by the scheduler.</span>
                    finalscore <span class="token operator">:=</span> score <span class="token operator">*</span> weight <span class="token operator">*</span> <span class="token punctuation">(</span>framework<span class="token punctuation">.</span>MaxNodeScore <span class="token operator">/</span> extenderv1<span class="token punctuation">.</span>MaxExtenderPriority<span class="token punctuation">)</span>

                    <span class="token keyword">if</span> allNodeExtendersScores<span class="token punctuation">[</span>nodename<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        allNodeExtendersScores<span class="token punctuation">[</span>nodename<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">{</span>
                            Name<span class="token punctuation">:</span>   nodename<span class="token punctuation">,</span>
                            Scores<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>PluginScore<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>extenders<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    allNodeExtendersScores<span class="token punctuation">[</span>nodename<span class="token punctuation">]</span><span class="token punctuation">.</span>Scores <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>allNodeExtendersScores<span class="token punctuation">[</span>nodename<span class="token punctuation">]</span><span class="token punctuation">.</span>Scores<span class="token punctuation">,</span> framework<span class="token punctuation">.</span>PluginScore<span class="token punctuation">{</span>
                        Name<span class="token punctuation">:</span>  extenders<span class="token punctuation">[</span>extIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        Score<span class="token punctuation">:</span> finalscore<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    allNodeExtendersScores<span class="token punctuation">[</span>nodename<span class="token punctuation">]</span><span class="token punctuation">.</span>TotalScore <span class="token operator">+=</span> finalscore
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// wait for all go routines to finish</span>
        wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> nodesScores <span class="token punctuation">{</span>
            <span class="token keyword">if</span> score<span class="token punctuation">,</span> ok <span class="token operator">:=</span> allNodeExtendersScores<span class="token punctuation">[</span>nodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                nodesScores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Scores <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>nodesScores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Scores<span class="token punctuation">,</span> score<span class="token punctuation">.</span>Scores<span class="token operator">...</span><span class="token punctuation">)</span>
                nodesScores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>TotalScore <span class="token operator">+=</span> score<span class="token punctuation">.</span>TotalScore
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> loggerVTen<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> nodesScores <span class="token punctuation">{</span>
            loggerVTen<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Calculated node&apos;s final score for pod&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> nodesScores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">&quot;score&quot;</span><span class="token punctuation">,</span> nodesScores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>TotalScore<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> nodesScores<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x901A;&#x8FC7;&#x5BF9;<code>Kubernetes&#x6E90;&#x7801;</code>&#x7684;&#x5B66;&#x4E60;&#xFF0C;&#x53EF;&#x4EE5;&#x611F;&#x89C9;&#x5230;&#x5B83;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x5F88;&#x7ED3;&#x6784;&#x5316;&#x7684;&#xFF0C;<code>prioritizeNodes()</code>&#x51FD;&#x6570;&#x6574;&#x4F53;&#x8F83;&#x957F;&#xFF0C;&#x6211;&#x4EEC;&#x5206;&#x5757;&#x6765;&#x7406;&#x6E05;&#x5B83;&#x7684;&#x903B;&#x8F91;&#x3002;&#x9996;&#x5148;&#x6839;&#x636E;&#x51FD;&#x6570;&#x7B7E;&#x540D;&#xFF0C;&#x5B83;&#x7684;&#x5165;&#x53C2;&#x5305;&#x62EC;&#xFF1A;&#x7528;&#x4E8E;&#x63A7;&#x5236;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x53C2;&#x6570;<code>ctx</code>&#xFF0C;&#x8C03;&#x5EA6;&#x6269;&#x5C55;&#x5668;<code>extenders</code>&#xFF0C;&#x8C03;&#x5EA6;&#x6846;&#x67B6;&#x5B9E;&#x4F8B;<code>fwk</code>&#xFF0C;&#x5B58;&#x50A8;&#x8C03;&#x5EA6;&#x72B6;&#x6001;&#x7684;<code>state</code>&#xFF0C;Pod&#x4FE1;&#x606F;&#x5BF9;&#x8C61;<code>pod</code>&#xFF0C;&#x4EE5;&#x53CA;&#x4E0A;&#x4E00;&#x6B65;&#x8FD4;&#x56DE;&#x7684;&#x8282;&#x70B9;&#x5217;&#x8868;<code>nodes</code>&#x3002;&#x8FD4;&#x56DE;&#x503C;&#x662F;&#x4E00;&#x4E2A;<code>NodePluginScores</code>&#x5207;&#x7247;&#x7C7B;&#x578B;&#x7684;&#x8282;&#x70B9;&#x8BC4;&#x5206;&#x7ED3;&#x679C;&#xFF0C;&#x540E;&#x7EED;&#x4F1A;&#x7ECF;&#x8FC7;<code>selectHost()</code>&#x51FD;&#x6570;&#xFF0C;&#x6700;&#x7EC8;&#x6572;&#x5B9A;&#x7684;&#x76EE;&#x6807;&#x8282;&#x70B9;&#x5E76;&#x8FD4;&#x56DE;&#x8282;&#x70B9;&#x540D;&#x79F0;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">prioritizeNodes</span><span class="token punctuation">(</span>
    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
    extenders <span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>Extender<span class="token punctuation">,</span>
    fwk framework<span class="token punctuation">.</span>Framework<span class="token punctuation">,</span>
    state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span>
    pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>
    nodes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x5148;&#x6765;&#x770B;&#x4E0D;&#x5305;&#x62EC;&#x8C03;&#x5EA6;&#x6269;&#x5C55;&#x5668;&#x7684;&#x903B;&#x8F91;&#x90E8;&#x5206;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8C03;&#x5EA6;&#x6269;&#x5C55;&#x5668;&#x548C;<code>Score</code>&#x63D2;&#x4EF6;&#xFF0C;&#x5C31;&#x628A;&#x6240;&#x6709;&#x7684;&#x8282;&#x70B9;&#x90FD;&#x6253;<code>1&#x5206;</code>&#x7136;&#x540E;&#x8FD4;&#x56DE;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">prioritizeNodes</span><span class="token punctuation">(</span>
    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
    extenders <span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>Extender<span class="token punctuation">,</span>
    fwk framework<span class="token punctuation">.</span>Framework<span class="token punctuation">,</span>
    state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span>
    pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>
    nodes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token comment">// &#x6CA1;&#x6709;&#x6269;&#x5C55;&#x5668;&#x4E5F;&#x6CA1;&#x6709;&#x8BC4;&#x5206;&#x63D2;&#x4EF6; &#x7EDF;&#x4E00;&#x7ED9;&#x4E00;&#x5206;&#x5E76;&#x8FD4;&#x56DE;</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>extenders<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fwk<span class="token punctuation">.</span><span class="token function">HasScorePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> nodes <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">{</span>
                Name<span class="token punctuation">:</span>       nodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
                TotalScore<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// PreScore&#x6269;&#x5C55;&#x70B9;</span>
    preScoreStatus <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">RunPreScorePlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>preScoreStatus<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> preScoreStatus<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Score&#x6269;&#x5C55;&#x70B9;</span>
    nodesScores<span class="token punctuation">,</span> scoreStatus <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">RunScorePlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>scoreStatus<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> scoreStatus<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x8BE6;&#x7EC6;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;</span>
    loggerVTen <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> loggerVTen<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> nodeScore <span class="token operator">:=</span> <span class="token keyword">range</span> nodesScores <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pluginScore <span class="token operator">:=</span> <span class="token keyword">range</span> nodeScore<span class="token punctuation">.</span>Scores <span class="token punctuation">{</span>
                loggerVTen<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Plugin scored node for pod&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;plugin&quot;</span><span class="token punctuation">,</span> pluginScore<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> nodeScore<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">&quot;score&quot;</span><span class="token punctuation">,</span> pluginScore<span class="token punctuation">.</span>Score<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>RunPreScorePlugins()</code>&#x7684;&#x5B9E;&#x73B0;&#x548C;<code>RunPreFilterPlugins()</code>&#x975E;&#x5E38;&#x7C7B;&#x4F3C;&#xFF0C;&#x540C;&#x6837;&#x662F;&#x505A;&#x4E86;&#x4E24;&#x5927;&#x7C7B;&#x4E8B;&#x60C5;&#xFF1A;&#x5728;&#x904D;&#x5386;&#x6267;&#x884C;<code>PreScore</code>&#x63D2;&#x4EF6;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x8C03;&#x7528;<code>cycleState.Write()</code>&#x8BB0;&#x5F55;&#x4FE1;&#x606F;&#x5230;<code>cycleState</code>&#x4E2D;&#xFF0C;&#x5982;&#x6C61;&#x70B9;&#x5BB9;&#x5FCD;&#x548C;&#x4EB2;&#x548C;&#x6027;&#x7B49;&#xFF0C;&#x5E76;&#x5728;&#x904D;&#x5386;&#x7ED3;&#x675F;&#x540E;&#x628A;&#x6CA1;&#x6709;&#x76F8;&#x5173;&#x6761;&#x4EF6;&#x540E;&#x7EED;&#x4E0D;&#x9700;&#x8981;&#x6267;&#x884C;&#x7684;<code>Score</code>&#x63D2;&#x4EF6;&#x4E5F;&#x8BB0;&#x5F55;&#x5230;<code>cycleState</code>&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>frameworkImpl<span class="token punctuation">)</span> <span class="token function">RunPreScorePlugins</span><span class="token punctuation">(</span>
    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
    state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span>
    pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>
    nodes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span>status <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    skipPlugins <span class="token operator">:=</span> sets<span class="token punctuation">.</span>New<span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// &#x6700;&#x540E;&#x628A;Score&#x9636;&#x6BB5;&#x4E0D;&#x9700;&#x8981;&#x6267;&#x884C;&#x7684;&#x63D2;&#x4EF6;&#x8BB0;&#x5F55;&#x5230;cycleState</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>SkipScorePlugins <span class="token operator">=</span> skipPlugins
        metrics<span class="token punctuation">.</span>FrameworkExtensionPointDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>PreScore<span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>profileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    verboseLogs <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> verboseLogs <span class="token punctuation">{</span>
        logger <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithName</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> <span class="token string">&quot;PreScore&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x904D;&#x5386;&#x6267;&#x884C;PreScore&#x63D2;&#x4EF6;&#x903B;&#x8F91;</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pl <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>preScorePlugins <span class="token punctuation">{</span>
        ctx <span class="token operator">:=</span> ctx
        <span class="token keyword">if</span> verboseLogs <span class="token punctuation">{</span>
            logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithName</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            ctx <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        status <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">runPreScorePlugin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>
        <span class="token keyword">if</span> status<span class="token punctuation">.</span><span class="token function">IsSkip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            skipPlugins<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;running PreScore plugin %q: %w&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4EE5;Kubernetes&#x7684;&#x9ED8;&#x8BA4;&#x63D2;&#x4EF6;&#x914D;&#x7F6E;&#x4E3A;&#x4F8B;&#xFF0C;&#x5206;&#x6790;<code>PreScore</code>&#x548C;<code>Score</code>&#x63D2;&#x4EF6;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x7531;&#x4E8E;<code>Weight</code>&#x6743;&#x91CD;&#x5B57;&#x6BB5;&#x4E00;&#x5B9A;&#x662F;&#x4F5C;&#x7528;&#x4E8E;<code>Score</code>&#x76F8;&#x5173;&#x7684;&#x6269;&#x5C55;&#x70B9;&#xFF0C;&#x6240;&#x4EE5;&#x9009;&#x62E9;<code>TaintToleration</code>&#x63D2;&#x4EF6;&#x4F5C;&#x4E3A;&#x5206;&#x6790;&#x5BF9;&#x8C61;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">getDefaultPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>v1<span class="token punctuation">.</span>Plugins <span class="token punctuation">{</span>
    plugins <span class="token operator">:=</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>Plugins<span class="token punctuation">{</span>
        MultiPoint<span class="token punctuation">:</span> v1<span class="token punctuation">.</span>PluginSet<span class="token punctuation">{</span>
            Enabled<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>Plugin<span class="token punctuation">{</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>SchedulingGates<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>PrioritySort<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>NodeUnschedulable<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>NodeName<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>TaintToleration<span class="token punctuation">,</span> Weight<span class="token punctuation">:</span> ptr<span class="token punctuation">.</span>To<span class="token punctuation">[</span><span class="token builtin">int32</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>NodeAffinity<span class="token punctuation">,</span> Weight<span class="token punctuation">:</span> ptr<span class="token punctuation">.</span>To<span class="token punctuation">[</span><span class="token builtin">int32</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>NodePorts<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>NodeResourcesFit<span class="token punctuation">,</span> Weight<span class="token punctuation">:</span> ptr<span class="token punctuation">.</span>To<span class="token punctuation">[</span><span class="token builtin">int32</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>VolumeRestrictions<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>NodeVolumeLimits<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>VolumeBinding<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>VolumeZone<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>PodTopologySpread<span class="token punctuation">,</span> Weight<span class="token punctuation">:</span> ptr<span class="token punctuation">.</span>To<span class="token punctuation">[</span><span class="token builtin">int32</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>InterPodAffinity<span class="token punctuation">,</span> Weight<span class="token punctuation">:</span> ptr<span class="token punctuation">.</span>To<span class="token punctuation">[</span><span class="token builtin">int32</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>DefaultPreemption<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>NodeResourcesBalancedAllocation<span class="token punctuation">,</span> Weight<span class="token punctuation">:</span> ptr<span class="token punctuation">.</span>To<span class="token punctuation">[</span><span class="token builtin">int32</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>ImageLocality<span class="token punctuation">,</span> Weight<span class="token punctuation">:</span> ptr<span class="token punctuation">.</span>To<span class="token punctuation">[</span><span class="token builtin">int32</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>Name<span class="token punctuation">:</span> names<span class="token punctuation">.</span>DefaultBinder<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token function">applyFeatureGates</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span>

    <span class="token keyword">return</span> plugins
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5728;&#x7ECF;&#x8FC7;&#x4ECE;<code>&#x7B97;&#x6CD5;&#x786C;&#x7F16;&#x7801;</code>&#x5230;<code>Scheduler Framework</code>&#x7684;&#x91CD;&#x6784;&#x540E;&#xFF0C;&#x63D2;&#x4EF6;&#x90FD;&#x5728;&#x8DEF;&#x5F84;<code>pkg/scheduler/framework/plugins</code>&#x4E0B;&#x5B9A;&#x4E49;&#x3002;<code>TaintToleration</code>&#x63D2;&#x4EF6;&#x53EF;&#x4EE5;&#x5728;&#x8BE5;&#x8DEF;&#x5F84;&#x4E0B;&#x627E;&#x5230;&#xFF0C;&#x4E00;&#x822C;&#x6BCF;&#x4E2A;&#x63D2;&#x4EF6;&#x76EE;&#x5F55;&#x4E0B;&#x90FD;&#x662F;&#x7531;&#x7B97;&#x6CD5;&#x5B9E;&#x73B0;&#x548C;&#x5355;&#x5143;&#x6D4B;&#x8BD5;&#x4E24;&#x4E2A;&#x6587;&#x4EF6;&#x7EC4;&#x6210;&#x3002;</p>
<p>&#x5728;<code>taint_toleration.go</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8BE5;&#x63D2;&#x4EF6;&#x5B9E;&#x73B0;&#x4E86;<code>Filter&#x3001;PreScore&#x3001;Score&#x3001;NormalizeScore</code>&#x63A5;&#x53E3;&#xFF0C;&#x5176;&#x4E2D;&#x7684;&#x903B;&#x8F91;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;<code>PreScore</code>&#x6269;&#x5C55;&#x70B9;&#x65F6;&#x4F7F;&#x7528;<code>cycleState.Write()</code>&#x8BB0;&#x5F55;&#x6C61;&#x70B9;&#x5BB9;&#x5FCD;&#x4FE1;&#x606F;&#x5230;<code>cycleState</code>&#xFF0C;&#x5230;<code>Score</code>&#x6269;&#x5C55;&#x70B9;&#x65F6;<code>TaintToleration</code>&#x6839;&#x636E;&#x5199;&#x5165;&#x65F6;&#x7684;key&#x4F7F;&#x7528;<code>cycleState.Read()</code>&#x8BFB;&#x51FA;<code>PreScore</code>&#x9636;&#x6BB5;&#x8BB0;&#x5F55;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x80FD;&#x5BB9;&#x5FCD;&#x8F6F;&#x6027;&#x6C61;&#x70B9;&#x5C31;&#x8BA1;&#x6570;&#x52A0;&#x4E00;&#xFF0C;&#x6700;&#x540E;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x3002;<code>NormalizeScore</code>&#x6269;&#x5C55;&#x70B9;&#x8C03;&#x7528;&#x4E86;&#x9ED8;&#x8BA4;&#x7684;&#x5F52;&#x4E00;&#x5316;&#x903B;&#x8F91;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pl <span class="token operator">*</span>TaintToleration<span class="token punctuation">)</span> <span class="token function">PreScore</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cycleState <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">)</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    tolerationsPreferNoSchedule <span class="token operator">:=</span> <span class="token function">getAllTolerationPreferNoSchedule</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Tolerations<span class="token punctuation">)</span>
    state <span class="token operator">:=</span> <span class="token operator">&amp;</span>preScoreState<span class="token punctuation">{</span>
        tolerationsPreferNoSchedule<span class="token punctuation">:</span> tolerationsPreferNoSchedule<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    cycleState<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>preScoreStateKey<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pl <span class="token operator">*</span>TaintToleration<span class="token punctuation">)</span> <span class="token function">Score</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nodeInfo<span class="token punctuation">,</span> err <span class="token operator">:=</span> pl<span class="token punctuation">.</span>handle<span class="token punctuation">.</span><span class="token function">SnapshotSharedLister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NodeInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>nodeName<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;getting node %q from Snapshot: %w&quot;</span><span class="token punctuation">,</span> nodeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    node <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    s<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getPreScoreState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    score <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">countIntolerableTaintsPreferNoSchedule</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Taints<span class="token punctuation">,</span> s<span class="token punctuation">.</span>tolerationsPreferNoSchedule<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> score<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pl <span class="token operator">*</span>TaintToleration<span class="token punctuation">)</span> <span class="token function">NormalizeScore</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> scores framework<span class="token punctuation">.</span>NodeScoreList<span class="token punctuation">)</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status <span class="token punctuation">{</span>
    <span class="token keyword">return</span> helper<span class="token punctuation">.</span><span class="token function">DefaultNormalizeScore</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>MaxNodeScore<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> scores<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">countIntolerableTaintsPreferNoSchedule</span><span class="token punctuation">(</span>taints <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>Taint<span class="token punctuation">,</span> tolerations <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>Toleration<span class="token punctuation">)</span> <span class="token punctuation">(</span>intolerableTaints <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> taint <span class="token operator">:=</span> <span class="token keyword">range</span> taints <span class="token punctuation">{</span>
        <span class="token comment">// &#x4EC5;&#x5904;&#x7406;&#x8F6F;&#x6027;&#x6C61;&#x70B9;</span>
        <span class="token keyword">if</span> taint<span class="token punctuation">.</span>Effect <span class="token operator">!=</span> v1<span class="token punctuation">.</span>TaintEffectPreferNoSchedule <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &#x4E0D;&#x80FD;&#x5BB9;&#x5FCD;&#x8BE5;&#x6C61;&#x70B9;&#x65F6;&#x8BA1;&#x6570;+1</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>v1helper<span class="token punctuation">.</span><span class="token function">TolerationsTolerateTaint</span><span class="token punctuation">(</span>tolerations<span class="token punctuation">,</span> <span class="token operator">&amp;</span>taint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intolerableTaints<span class="token operator">++</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x8FD4;&#x56DE;&#x4E0D;&#x80FD;&#x5BB9;&#x5FCD;&#x6C61;&#x70B9;&#x8BA1;&#x6570;&#x7ED3;&#x679C;</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="score&#x6269;&#x5C55;&#x70B9;&#x4E0E;normalizescore&#x8BC4;&#x5206;&#x5F52;&#x4E00;&#x5316;"><a name="score&#x6269;&#x5C55;&#x70B9;&#x4E0E;normalizescore&#x8BC4;&#x5206;&#x5F52;&#x4E00;&#x5316;" class="anchor-navigation-ex-anchor" href="#score&#x6269;&#x5C55;&#x70B9;&#x4E0E;normalizescore&#x8BC4;&#x5206;&#x5F52;&#x4E00;&#x5316;"><i class="fa fa-link" aria-hidden="true"></i></a>2.1. Score&#x6269;&#x5C55;&#x70B9;&#x4E0E;NormalizeScore&#x8BC4;&#x5206;&#x5F52;&#x4E00;&#x5316;</h3>
<p><code>RunScorePlugins()</code>&#x7684;&#x5B9E;&#x73B0;&#x548C;<code>RunFilterPlugins()</code>&#x7C7B;&#x4F3C;&#x3002;&#x9996;&#x5148;&#xFF0C;<code>Filter</code>&#x63D2;&#x4EF6;&#x6267;&#x884C;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x72B6;&#x6001;&#x88AB;&#x5B58;&#x50A8;&#x5728;<code>CycleState</code>&#x5BF9;&#x8C61;&#x5E76;&#x8BFB;&#x5199;&#xFF0C;&#x8FC7;&#x6EE4;&#x7684;&#x884C;&#x4E3A;&#x5C5E;&#x4E8E;&#x8D23;&#x4EFB;&#x94FE;&#x6A21;&#x5F0F;&#xFF0C;&#x5982;&#x679C;&#x4E00;&#x5904;&#x4E0D;&#x901A;&#x8FC7;&#x5C31;&#x76F4;&#x63A5;&#x5931;&#x8D25;&#x9000;&#x51FA;&#xFF0C;&#x6240;&#x4EE5;&#x8FC7;&#x6EE4;&#x9636;&#x6BB5;&#x8282;&#x70B9;&#x5C42;&#x9762;&#x5E76;&#x884C;&#x4F46;&#x63D2;&#x4EF6;&#x5C42;&#x9762;&#x662F;&#x4E32;&#x884C;&#x7684;&#x3002;&#x8BC4;&#x5206;&#x9636;&#x6BB5;&#x4E5F;&#x662F;&#x8282;&#x70B9;&#x5C42;&#x9762;&#x4E32;&#x884C;&#x548C;&#x63D2;&#x4EF6;&#x5C42;&#x9762;&#x5E76;&#x884C;&#xFF0C;&#x5982;&#x6709;&#x7591;&#x95EE;&#x53EF;&#x4EE5;&#x5BF9;&#x6BD4;<code>Predicates</code>&#x9636;&#x6BB5;&#x7684;<code>findNodesThatPassFilters()</code>&#x4E0E;<code>Priorities</code>&#x9636;&#x6BB5;&#x7684;<code>RunScorePlugins()</code>&#x65B9;&#x6CD5;&#x5E76;&#x52A0;&#x4EE5;&#x8BE6;&#x7EC6;&#x5BF9;&#x6BD4;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>frameworkImpl<span class="token punctuation">)</span> <span class="token function">RunScorePlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">)</span> <span class="token punctuation">(</span>ns <span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> status <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        metrics<span class="token punctuation">.</span>FrameworkExtensionPointDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>Score<span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>profileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    allNodePluginScores <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    numPlugins <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>scorePlugins<span class="token punctuation">)</span>
    plugins <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>ScorePlugin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numPlugins<span class="token punctuation">)</span>
    pluginToNodeScores <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodeScoreList<span class="token punctuation">,</span> numPlugins<span class="token punctuation">)</span>
    <span class="token comment">// &#x521D;&#x59CB;&#x5316;Score&#x6269;&#x5C55;&#x70B9;&#x4F7F;&#x7528;&#x7684;&#x63D2;&#x4EF6;&#x5217;&#x8868;</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pl <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>scorePlugins <span class="token punctuation">{</span>
        <span class="token keyword">if</span> state<span class="token punctuation">.</span>SkipScorePlugins<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        plugins <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>plugins<span class="token punctuation">,</span> pl<span class="token punctuation">)</span>
        pluginToNodeScores<span class="token punctuation">[</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>NodeScoreList<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x521B;&#x5EFA;&#x4E0A;&#x4E0B;&#x6587;&#x5BF9;&#x8C61;</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    errCh <span class="token operator">:=</span> parallelize<span class="token punctuation">.</span><span class="token function">NewErrorChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// Score&#x63D2;&#x4EF6;&#x5217;&#x8868;&#x4E0D;&#x4E3A;&#x7A7A;&#x65F6;</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        verboseLogs <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> verboseLogs <span class="token punctuation">{</span>
            logger <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithName</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> <span class="token string">&quot;Score&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &#x4E3A;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x5E76;&#x53D1;&#x6267;&#x884C;&#x8BC4;&#x5206;&#x64CD;&#x4F5C;</span>
        f<span class="token punctuation">.</span><span class="token function">Parallelizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nodeName <span class="token operator">:=</span> nodes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name
            logger <span class="token operator">:=</span> logger
            <span class="token keyword">if</span> verboseLogs <span class="token punctuation">{</span>
                logger <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithValues</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span>ObjectRef<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> nodeName<span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Score&#x63D2;&#x4EF6;&#x7EA7;&#x522B;&#x4E32;&#x884C;</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pl <span class="token operator">:=</span> <span class="token keyword">range</span> plugins <span class="token punctuation">{</span>
                ctx <span class="token operator">:=</span> ctx
                <span class="token keyword">if</span> verboseLogs <span class="token punctuation">{</span>
                    logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithName</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    ctx <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> logger<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                s<span class="token punctuation">,</span> status <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">runScorePlugin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;plugin %q failed with: %w&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    errCh<span class="token punctuation">.</span><span class="token function">SendErrorWithCancel</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> cancel<span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// &#x8BB0;&#x5F55;&#x8BC4;&#x5206;&#x4FE1;&#x606F;&#x5230;pluginToNodeScores</span>
                pluginToNodeScores<span class="token punctuation">[</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> framework<span class="token punctuation">.</span>NodeScore<span class="token punctuation">{</span>
                    Name<span class="token punctuation">:</span>  nodeName<span class="token punctuation">,</span>
                    Score<span class="token punctuation">:</span> s<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>Score<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> errCh<span class="token punctuation">.</span><span class="token function">ReceiveError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;running Score plugins: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// NormalizeScore&#x6269;&#x5C55;&#x70B9;</span>
    <span class="token comment">// &#x4E3A;&#x6BCF;&#x4E2A;&#x63D2;&#x4EF6;&#x5E76;&#x53D1;&#x6267;&#x884C;&#x8BC4;&#x5206;&#x5F52;&#x4E00;&#x5316;</span>
    f<span class="token punctuation">.</span><span class="token function">Parallelizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pl <span class="token operator">:=</span> plugins<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token comment">// Score&#x63D2;&#x4EF6;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;ScoreExtensions()&#x65B9;&#x6CD5; &#x5982;&#x679C;&#x4E0D;&#x9700;&#x8981;&#x5F52;&#x4E00;&#x5316;&#x5C31;&#x5728;&#x8BE5;&#x65B9;&#x6CD5;&#x4E2D;&#x8FD4;&#x56DE;nil</span>
        <span class="token keyword">if</span> pl<span class="token punctuation">.</span><span class="token function">ScoreExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        nodeScoreList <span class="token operator">:=</span> pluginToNodeScores<span class="token punctuation">[</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token comment">// &#x6709;&#x5F52;&#x4E00;&#x5316;&#x9700;&#x8981;&#x7684;&#x6267;&#x884C;&#x63D2;&#x4EF6;&#x7684;NormalizeScore()&#x65B9;&#x6CD5;&#x5E76;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;</span>
        status <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">runScoreExtension</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeScoreList<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;plugin %q failed with: %w&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            errCh<span class="token punctuation">.</span><span class="token function">SendErrorWithCancel</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> cancel<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>Score<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> errCh<span class="token punctuation">.</span><span class="token function">ReceiveError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;running Normalize on Score plugins: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x6309;&#x8282;&#x70B9;&#x7C92;&#x5EA6;&#x5E76;&#x53D1;&#x6267;&#x884C; &#x6839;&#x636E;&#x6743;&#x91CD;&#x8C03;&#x6574;&#x6700;&#x7EC8;&#x8BC4;&#x5206;</span>
    f<span class="token punctuation">.</span><span class="token function">Parallelizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nodePluginScores <span class="token operator">:=</span> framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">{</span>
            Name<span class="token punctuation">:</span>   nodes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
            Scores<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>PluginScore<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> i<span class="token punctuation">,</span> pl <span class="token operator">:=</span> <span class="token keyword">range</span> plugins <span class="token punctuation">{</span>
            weight <span class="token operator">:=</span> f<span class="token punctuation">.</span>scorePluginWeight<span class="token punctuation">[</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            nodeScoreList <span class="token operator">:=</span> pluginToNodeScores<span class="token punctuation">[</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            score <span class="token operator">:=</span> nodeScoreList<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Score
            <span class="token comment">// &#x8BC4;&#x5206;&#x7684;&#x8303;&#x56F4;&#x5982;&#x679C;&#x4E0D;&#x5728;1-100&#x4E4B;&#x95F4;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;</span>
            <span class="token keyword">if</span> score <span class="token operator">&gt;</span> framework<span class="token punctuation">.</span>MaxNodeScore <span class="token operator">||</span> score <span class="token operator">&lt;</span> framework<span class="token punctuation">.</span>MinNodeScore <span class="token punctuation">{</span>
                err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;plugin %q returns an invalid score %v, it should in the range of [%v, %v] after normalizing&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> score<span class="token punctuation">,</span> framework<span class="token punctuation">.</span>MinNodeScore<span class="token punctuation">,</span> framework<span class="token punctuation">.</span>MaxNodeScore<span class="token punctuation">)</span>
                errCh<span class="token punctuation">.</span><span class="token function">SendErrorWithCancel</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> cancel<span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            weightedScore <span class="token operator">:=</span> score <span class="token operator">*</span> <span class="token function">int64</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span>
            <span class="token comment">// &#x8BB0;&#x5F55;&#x5355;&#x4E2A;&#x63D2;&#x4EF6;&#x6700;&#x7EC8;&#x8BC4;&#x5206;&#x5230;nodePluginScores</span>
            nodePluginScores<span class="token punctuation">.</span>Scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> framework<span class="token punctuation">.</span>PluginScore<span class="token punctuation">{</span>
                Name<span class="token punctuation">:</span>  pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Score<span class="token punctuation">:</span> weightedScore<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// &#x7D2F;&#x52A0;&#x8BB0;&#x5F55;&#x8282;&#x70B9;&#x603B;&#x5206;</span>
            nodePluginScores<span class="token punctuation">.</span>TotalScore <span class="token operator">+=</span> weightedScore
        <span class="token punctuation">}</span>
        allNodePluginScores<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> nodePluginScores
    <span class="token punctuation">}</span><span class="token punctuation">,</span> metrics<span class="token punctuation">.</span>Score<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> errCh<span class="token punctuation">.</span><span class="token function">ReceiveError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;applying score defaultWeights on Score plugins: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x8FD4;&#x56DE;&#x8282;&#x70B9;&#x8BC4;&#x5206;&#x7ED3;&#x679C;&#x5217;&#x8868;</span>
    <span class="token keyword">return</span> allNodePluginScores<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// &#x8282;&#x70B9;&#x8BC4;&#x5206;&#x7ED3;&#x6784;</span>
<span class="token keyword">type</span> NodePluginScores <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x8282;&#x70B9;&#x540D;&#x79F0;</span>
    Name <span class="token builtin">string</span>
    <span class="token comment">// &#x63D2;&#x4EF6;-&#x8BC4;&#x5206; &#x5217;&#x8868;</span>
    Scores <span class="token punctuation">[</span><span class="token punctuation">]</span>PluginScore
    <span class="token comment">// &#x603B;&#x5206;</span>
    TotalScore <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="normalizescore&#x63D2;&#x4EF6;"><a name="normalizescore&#x63D2;&#x4EF6;" class="anchor-navigation-ex-anchor" href="#normalizescore&#x63D2;&#x4EF6;"><i class="fa fa-link" aria-hidden="true"></i></a>2.2. NormalizeScore&#x63D2;&#x4EF6;</h3>
<p>&#x4E00;&#x4E9B;&#x63D2;&#x4EF6;&#x7684;<code>NormalizeScore()</code>&#x5B9E;&#x73B0;&#x662F;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4E86;&#x9ED8;&#x8BA4;&#x7684;&#x5F52;&#x4E00;&#x5316;&#x8BC4;&#x5206;&#x65B9;&#x6CD5;<code>DefaultNormalizeScore()</code>&#xFF0C;&#x5728;&#x6587;&#x4EF6;<code>pkg/scheduler/framework/plugins/helper/normalize_score.go</code>&#x4E2D;&#x5B9A;&#x4E49;&#xFF0C;&#x4EC5;&#x6CE8;&#x91CA;&#x4E0D;&#x505A;&#x8FC7;&#x591A;&#x8BF4;&#x660E;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">DefaultNormalizeScore</span><span class="token punctuation">(</span>maxPriority <span class="token builtin">int64</span><span class="token punctuation">,</span> reverse <span class="token builtin">bool</span><span class="token punctuation">,</span> scores framework<span class="token punctuation">.</span>NodeScoreList<span class="token punctuation">)</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status <span class="token punctuation">{</span>
    <span class="token keyword">var</span> maxCount <span class="token builtin">int64</span>
    <span class="token comment">// &#x83B7;&#x53D6;&#x6240;&#x6709;&#x8282;&#x70B9;&#x4E2D;&#x7684;&#x6700;&#x9AD8;&#x5206;</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> scores <span class="token punctuation">{</span>
        <span class="token keyword">if</span> scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score <span class="token operator">&gt;</span> maxCount <span class="token punctuation">{</span>
            maxCount <span class="token operator">=</span> scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x5982;&#x679C;&#x6240;&#x6709;&#x8282;&#x70B9;&#x8BC4;&#x5206;&#x90FD;&#x662F;0&#x7684;&#x60C5;&#x51B5;</span>
    <span class="token keyword">if</span> maxCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> reverse <span class="token punctuation">{</span>
            <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> scores <span class="token punctuation">{</span>
                scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score <span class="token operator">=</span> maxPriority
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x6B63;&#x5E38;&#x60C5;&#x51B5;</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> scores <span class="token punctuation">{</span>
        score <span class="token operator">:=</span> scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score
        <span class="token comment">// 100*&#x8BC4;&#x5206;/&#x6700;&#x9AD8;&#x5206;</span>
        score <span class="token operator">=</span> maxPriority <span class="token operator">*</span> score <span class="token operator">/</span> maxCount
        <span class="token comment">// reverse&#x7528;&#x4E8E;Score&#x8BC4;&#x5206;&#x4F4E;&#x8868;&#x793A;&#x66F4;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x7684;&#x60C5;&#x51B5; &#x5982;TaintToleration&#x63D2;&#x4EF6;</span>
        <span class="token keyword">if</span> reverse <span class="token punctuation">{</span>
            <span class="token comment">// &#x4F4E;&#x5206;&#x53CD;&#x8F6C;&#x53D8;&#x6210;&#x9AD8;&#x5206;</span>
            score <span class="token operator">=</span> maxPriority <span class="token operator">-</span> score
        <span class="token punctuation">}</span>
        <span class="token comment">// &#x8BB0;&#x5F55;&#x5F52;&#x4E00;&#x5316;&#x540E;&#x7684;&#x8BC4;&#x5206;</span>
        scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score <span class="token operator">=</span> score
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5BF9;&#x4E0A;&#x9762;&#x4F8B;&#x5982;<code>TaintToleration</code>&#x63D2;&#x4EF6;&#x7684;&#x4E86;&#x89E3;&#xFF0C;&#x4E0D;&#x96BE;&#x53D1;&#x73B0;&#x5176;&#x5B9E;&#x8C03;&#x5EA6;&#x5668;&#x7684;&#x7B97;&#x6CD5;&#x5B9E;&#x73B0;&#x5E76;&#x4E0D;&#x590D;&#x6742;&#xFF0C;&#x91CD;&#x70B9;&#x5728;&#x4E8E;&#x6574;&#x4F53;&#x6D41;&#x7A0B;&#x7684;&#x8BBE;&#x8BA1;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x5728;&#x4E86;&#x89E3;&#x4E86;<code>Scheduler Framework</code>&#x540E;&#xFF0C;Pod&#x7684;&#x6574;&#x4E2A;&#x8C03;&#x5EA6;&#x6D41;&#x7A0B;&#x5C31;&#x5DF2;&#x7ECF;&#x975E;&#x5E38;&#x6E05;&#x6670;&#x4E86;&#x3002;&#x5230;&#x76EE;&#x524D;&#x4E3A;&#x6B62;&#x603B;&#x5171;&#x63A5;&#x89E6;&#x5230;&#x4E86;<code>PreFilter</code>&#x3001;<code>Filter</code>&#x3001;<code>PreScore</code>&#x3001;<code>Score</code>&#x8FD9;&#x56DB;&#x4E2A;&#x6269;&#x5C55;&#x70B9;&#x7684;&#x63D2;&#x4EF6;(&#x5176;&#x4E2D;<code>NormalizeScore</code>&#x5728;<code>Score</code>&#x6269;&#x5C55;&#x70B9;&#x5185;&#x90E8;&#xFF0C;&#x4E0D;&#x5C5E;&#x4E8E;12&#x4E2A;&#x6807;&#x51C6;&#x6269;&#x5C55;&#x70B9;&#x4E4B;&#x4E00;)&#x3002;&#x5728;&#x7ED3;&#x5408;&#x6D41;&#x7A0B;&#x56FE;&#x4E2D;&#xFF0C;&#x524D;&#x9762;&#x6709;&#x4E09;&#x4E2A;&#x6269;&#x5C55;&#x70B9;&#x6CA1;&#x6709;&#x770B;&#x5230;&#xFF0C;&#x5206;&#x522B;&#x662F;<code>PreEnqueue</code>&#x3001;<code>QueueSort</code>&#x548C;<code>PostFilter</code>&#xFF0C;&#x5176;&#x4E2D;<code>PreEnqueue</code>&#x548C;<code>QueueSort</code>&#x662F;&#x8C03;&#x5EA6;&#x961F;&#x5217;&#x76F8;&#x5173;&#x7684;&#x4E24;&#x4E2A;&#x63D2;&#x4EF6;&#xFF0C;&#x6240;&#x4EE5;&#x6CA1;&#x6709;&#x51FA;&#x73B0;&#x5728;&#x8C03;&#x5EA6;&#x5468;&#x671F;&#x5185;&#xFF0C;&#x5982;&#x679C;&#x611F;&#x5174;&#x8DA3;&#x53EF;&#x4EE5;&#x56DE;&#x5230;&#x8C03;&#x5EA6;&#x961F;&#x5217;&#x7684;<code>runPreEnqueuePlugins()</code>&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5728;Pod&#x6DFB;&#x52A0;&#x5230;<code>ActiveQ</code>&#x65F6;&#x8C03;&#x7528;&#x3002;<code>QueueSort</code>&#x8C03;&#x7528;&#x70B9;&#x8F83;&#x4E3A;&#x9690;&#x853D;&#xFF0C;&#x53EF;&#x4EE5;&#x4EE5;<code>func (aq *activeQueue) update()</code>&#x4E3A;&#x5165;&#x53E3;&#xFF0C;&#x8C03;&#x7528;&#x5173;&#x7CFB;&#x5982;&#x4E0B;&#x65B9;&#x6240;&#x793A;&#xFF0C;&#x8C03;&#x5EA6;&#x961F;&#x5217;&#x5B9E;&#x4F8B;&#x521B;&#x5EFA;&#x4E4B;&#x521D;&#xFF0C;&#x5C31;&#x5411;&#x5176;&#x4E2D;&#x6CE8;&#x518C;&#x4E86;<code>Less()</code>&#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x7684;&#x8C03;&#x7528;&#x70B9;&#x4E0D;&#x50CF;&#x5176;&#x4ED6;&#x7684;&#x63D2;&#x4EF6;&#x662F;<code>runXXXPlugin()</code>&#x800C;&#x662F;<code>Less()</code>&#xFF0C;Pod&#x7684;&#x5165;&#x961F;&#x548C;&#x51FA;&#x961F;&#x90FD;&#x4F1A;&#x8C03;&#x7528;<code>Less()</code>&#x65B9;&#x6CD5;&#x3002;<code>PostFilter</code>&#x63D2;&#x4EF6;&#x53EA;&#x4E0E;&#x62A2;&#x5360;&#x6D41;&#x7A0B;&#x6709;&#x5173;&#xFF0C;&#x5728;&#x540E;&#x9762;&#x4F1A;&#x5355;&#x72EC;&#x4ECB;&#x7ECD;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// &#x5165;&#x961F;&#x7684;&#x8C03;&#x7528;&#x94FE; activeQueue.update-&gt;queue.AddOrUpdate-&gt;heap.Push-&gt;up</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>aq <span class="token operator">*</span>activeQueue<span class="token punctuation">)</span> <span class="token function">update</span><span class="token punctuation">(</span>newPod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> oldPodInfo <span class="token operator">*</span>framework<span class="token punctuation">.</span>QueuedPodInfo<span class="token punctuation">)</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>QueuedPodInfo <span class="token punctuation">{</span>
    aq<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> aq<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> pInfo<span class="token punctuation">,</span> exists <span class="token operator">:=</span> aq<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>oldPodInfo<span class="token punctuation">)</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> pInfo<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>newPod<span class="token punctuation">)</span>
        aq<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">AddOrUpdate</span><span class="token punctuation">(</span>pInfo<span class="token punctuation">)</span>
        <span class="token keyword">return</span> pInfo
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>Heap<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">AddOrUpdate</span><span class="token punctuation">(</span>obj T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    key <span class="token operator">:=</span> h<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exists <span class="token operator">:=</span> h<span class="token punctuation">.</span>data<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span>
        h<span class="token punctuation">.</span>data<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj
        heap<span class="token punctuation">.</span><span class="token function">Fix</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>data<span class="token punctuation">,</span> h<span class="token punctuation">.</span>data<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        heap<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>itemKeyValue<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">{</span>key<span class="token punctuation">,</span> obj<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> h<span class="token punctuation">.</span>metricRecorder <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            h<span class="token punctuation">.</span>metricRecorder<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// golang&#x7684;container/heap&#x5305;</span>
<span class="token keyword">func</span> <span class="token function">Push</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">,</span> x any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    h<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token function">up</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> h<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">up</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        i <span class="token operator">:=</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token comment">// parent</span>
        <span class="token comment">// &#x76F4;&#x63A5;&#x8C03;&#x7528;&#x70B9;</span>
        <span class="token keyword">if</span> i <span class="token operator">==</span> j <span class="token operator">||</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">Less</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        h<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>
        j <span class="token operator">=</span> i
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// &#x51FA;&#x961F;&#x7684;&#x8C03;&#x7528;&#x94FE; activeQueue.pop-&gt;activeQueue.unlockedPop-&gt;queue.Pop-&gt;heap.Pop-&gt;down</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>aq <span class="token operator">*</span>activeQueue<span class="token punctuation">)</span> <span class="token function">pop</span><span class="token punctuation">(</span>logger klog<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>QueuedPodInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    aq<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> aq<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> aq<span class="token punctuation">.</span><span class="token function">unlockedPop</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>aq <span class="token operator">*</span>activeQueue<span class="token punctuation">)</span> <span class="token function">unlockedPop</span><span class="token punctuation">(</span>logger klog<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>framework<span class="token punctuation">.</span>QueuedPodInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> aq<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> aq<span class="token punctuation">.</span>closed <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Scheduling queue is closed&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        aq<span class="token punctuation">.</span>cond<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    pInfo<span class="token punctuation">,</span> err <span class="token operator">:=</span> aq<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>Heap<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    obj <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> obj <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> h<span class="token punctuation">.</span>metricRecorder <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            h<span class="token punctuation">.</span>metricRecorder<span class="token punctuation">.</span><span class="token function">Dec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> zero T
    <span class="token keyword">return</span> zero<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;heap is empty&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// golang&#x7684;container/heap&#x5305;</span>
<span class="token keyword">func</span> <span class="token function">Pop</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">)</span> any <span class="token punctuation">{</span>
    n <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
    h<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    <span class="token function">down</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    <span class="token keyword">return</span> h<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">down</span><span class="token punctuation">(</span>h Interface<span class="token punctuation">,</span> i0<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    i <span class="token operator">:=</span> i0
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        j1 <span class="token operator">:=</span> <span class="token number">2</span><span class="token operator">*</span>i <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">if</span> j1 <span class="token operator">&gt;=</span> n <span class="token operator">||</span> j1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">// j1 &lt; 0 after int overflow</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        j <span class="token operator">:=</span> j1 <span class="token comment">// left child</span>
        <span class="token comment">// &#x76F4;&#x63A5;&#x8C03;&#x7528;&#x70B9;</span>
        <span class="token keyword">if</span> j2 <span class="token operator">:=</span> j1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j2 <span class="token operator">&lt;</span> n <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span><span class="token function">Less</span><span class="token punctuation">(</span>j2<span class="token punctuation">,</span> j1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            j <span class="token operator">=</span> j2 <span class="token comment">// = 2*i + 2  // right child</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">Less</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        h<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>
        i <span class="token operator">=</span> j
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> i <span class="token operator">&gt;</span> i0
<span class="token punctuation">}</span>
</code></pre>
<h3 id="selecthost"><a name="selecthost" class="anchor-navigation-ex-anchor" href="#selecthost"><i class="fa fa-link" aria-hidden="true"></i></a>2.3. SelectHost</h3>
<p>&#x6B64;&#x65F6;&#x5DF2;&#x7ECF;&#x5F97;&#x5230;&#x4E86;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x548C;&#x5176;&#x8BC4;&#x5206;&#x7684;&#x5BF9;&#x5E94;&#x5173;&#x7CFB;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x8FDB;&#x884C;<code>Priorities</code>&#x9636;&#x6BB5;&#x7684;&#x6700;&#x540E;&#x4E00;&#x6B65;&#xFF0C;&#x90A3;&#x5C31;&#x662F;&#x4ECE;&#x4E0A;&#x4E00;&#x6B65;&#x7684;&#x7ED3;&#x679C;&#x4E2D;&#x9009;&#x51FA;&#x6700;&#x4F18;&#x5148;&#x7684;&#x90A3;&#x4E2A;&#xFF0C;&#x7136;&#x540E;&#x4EE5;<code>ScheduleResult</code>&#x7ED3;&#x6784;&#x7684;&#x5F62;&#x5F0F;&#x8FD4;&#x56DE;&#x7ED9;&#x4E0A;&#x5C42;&#x3002;</p>
<pre class="language-"><code class="lang-go">host<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">selectHost</span><span class="token punctuation">(</span>priorityList<span class="token punctuation">,</span> numberOfHighestScoredNodesToReport<span class="token punctuation">)</span>
<span class="token keyword">return</span> ScheduleResult<span class="token punctuation">{</span>
        SuggestedHost<span class="token punctuation">:</span>  host<span class="token punctuation">,</span>
        EvaluatedNodes<span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>feasibleNodes<span class="token punctuation">)</span> <span class="token operator">+</span> diagnosis<span class="token punctuation">.</span>NodeToStatus<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        FeasibleNodes<span class="token punctuation">:</span>  <span class="token function">len</span><span class="token punctuation">(</span>feasibleNodes<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> err
</code></pre>
<p>&#x5176;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x8F93;&#x5165;&#x53C2;&#x6570;&#x662F;<code>numberOfHighestScoredNodesToReport</code>&#xFF0C;&#x5B83;&#x7684;&#x503C;&#x4E3A;3&#xFF0C;&#x53EF;&#x4EE5;&#x8986;&#x76D6;<code>&#x4E00;&#x4E3B;&#x4E24;&#x5907;</code>&#x7684;&#x573A;&#x666F;&#x5E76;&#x907F;&#x514D;&#x8BB0;&#x5F55;&#x8FC7;&#x591A;&#x4FE1;&#x606F;&#x7684;&#x5185;&#x5B58;&#x5360;&#x7528;&#xFF0C;&#x540C;&#x65F6;&#x7528;&#x4E8E;&#x62A2;&#x5360;&#x6D41;&#x7A0B;&#x548C;&#x9519;&#x8BEF;&#x8BB0;&#x5F55;&#xFF0C;&#x8BE5;&#x6570;&#x503C;&#x662F;&#x4FE1;&#x606F;&#x5B8C;&#x6574;&#x6027;&#x548C;&#x6027;&#x80FD;&#x4E4B;&#x95F4;&#x7684;&#x5E73;&#x8861;&#x70B9;&#x3002;</p>
<pre class="language-"><code class="lang-go">    <span class="token comment">// numberOfHighestScoredNodesToReport is the number of node scores</span>
    <span class="token comment">// to be included in ScheduleResult.</span>
    numberOfHighestScoredNodesToReport <span class="token operator">=</span> <span class="token number">3</span>
</code></pre>
<p>&#x4E0B;&#x9762;&#x5206;&#x6790;<code>selectHost()</code>&#x51FD;&#x6570;&#xFF0C;&#x9996;&#x5148;&#x662F;&#x5BF9;&#x957F;&#x5EA6;&#x505A;&#x4F8B;&#x884C;&#x7684;&#x5224;&#x65AD;&#xFF0C;&#x7136;&#x540E;&#x5F00;&#x59CB;&#x63D0;&#x53D6;&#x524D;&#x4E09;&#x8BC4;&#x5206;&#x7684;&#x8282;&#x70B9;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x8BBE;&#x8BA1;&#x91C7;&#x7528;&#x4E86;&#x84C4;&#x6C34;&#x6C60;&#x62BD;&#x6837;&#x6CD5;&#x3002;&#x9996;&#x5148;&#x521D;&#x59CB;&#x5316;&#x4E86;&#x4E00;&#x4E2A;&#x5217;&#x8868;&#xFF0C;&#x5E76;&#x628A;<code>nodeScoreHeap</code>&#x5806;&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;<code>Pop</code>&#x51FA;&#x6765;&#x52A0;&#x5165;&#x5230;&#x5217;&#x8868;&#x4E2D;&#xFF0C;&#x56E0;&#x4E3A;<code>nodeScoreHeap</code>&#x662F;&#x6309;<code>TotalScore</code>&#x4ECE;&#x9AD8;&#x5230;&#x4F4E;&#x6765;&#x6392;&#x5E8F;&#x7684;&#x3002;&#x7136;&#x540E;&#x5F00;&#x59CB;&#x5FAA;&#x73AF;&#x6DFB;&#x52A0;&#x5143;&#x7D20;&#xFF0C;&#x5728;&#x5207;&#x7247;&#x5B9E;&#x9645;&#x957F;&#x5EA6;&#x5C0F;&#x4E8E;&#x5BB9;&#x91CF;&#x65F6;&#xFF0C;&#x5148;&#x62FF;&#x5F53;&#x524D;&#x8282;&#x70B9;&#x7684;<code>TotalScore</code>&#x548C;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x7684;<code>TotalScore</code>&#x505A;&#x6BD4;&#x8F83;&#xFF0C;&#x5982;&#x679C;&#x503C;&#x76F8;&#x7B49;&#x5C31;&#x6839;&#x636E;&#x84C4;&#x6C34;&#x6C60;&#x62BD;&#x6837;&#x6CD5;&#xFF0C;&#x4EE5;<code>1/&#x76F8;&#x540C;&#x5206;&#x6570;&#x8282;&#x70B9;&#x6570;&#x91CF;</code>&#x7684;&#x6982;&#x7387;&#x66FF;&#x6362;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x4EE5;<code>selectedIndex</code>&#x52A8;&#x6001;&#x8BB0;&#x5F55;&#x5176;&#x4F4D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x5143;&#x7D20;&#x52A0;&#x6EE1;&#x4E4B;&#x540E;&#x4EA4;&#x6362;&#x5217;&#x8868;&#x4E2D;&#x4E24;&#x4E2A;&#x7D22;&#x5F15;&#x4F4D;&#x7F6E;&#x7684;&#x503C;&#xFF0C;&#x6700;&#x7EC8;&#x8FD4;&#x56DE;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x7684;&#x8282;&#x70B9;&#x540D;&#x79F0;&#x548C;&#x5206;&#x6570;&#x524D;&#x4E09;&#x7684;&#x8282;&#x70B9;&#x5217;&#x8868;&#xFF0C;&#x81F3;&#x6B64;<code>Priorities</code>&#x9636;&#x6BB5;&#x5B8C;&#x5168;&#x7ED3;&#x675F;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>h nodeScoreHeap<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> h<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>TotalScore <span class="token operator">&gt;</span> h<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>TotalScore <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">selectHost</span><span class="token punctuation">(</span>nodeScoreList <span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> count <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>nodeScoreList<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errEmptyPriorityList
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x521D;&#x59CB;&#x5316;&#x5806;&#x7ED3;&#x6784;&#x7684;&#x8282;&#x70B9;&#x8BC4;&#x5206;&#x5217;&#x8868;</span>
    <span class="token keyword">var</span> h nodeScoreHeap <span class="token operator">=</span> nodeScoreList
    heap<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">)</span>
    cntOfMaxScore <span class="token operator">:=</span> <span class="token number">1</span>
    selectedIndex <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token comment">// &#x5148;&#x63D0;&#x53D6;&#x7B2C;&#x4E00;&#x4E2A;&#x8282;&#x70B9; &#x5FC5;&#x7136;&#x662F;&#x6700;&#x9AD8;&#x5206;</span>
    sortedNodeScoreList <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
    sortedNodeScoreList <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>sortedNodeScoreList<span class="token punctuation">,</span> heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// &#x5FAA;&#x73AF;&#x6DFB;&#x52A0;&#x8282;&#x70B9;</span>
    <span class="token keyword">for</span> ns <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> ns <span class="token operator">=</span> heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>NodePluginScores<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x5F53;&#x524D;&#x8282;&#x70B9;&#x5206;&#x6570;&#x548C;&#x6700;&#x9AD8;&#x5206;&#x4E0D;&#x540C; &#x4E14;&#x8282;&#x70B9;&#x5217;&#x8868;&#x5DF2;&#x6EE1;&#x65F6;&#x9000;&#x51FA;&#x5FAA;&#x73AF;</span>
        <span class="token keyword">if</span> ns<span class="token punctuation">.</span>TotalScore <span class="token operator">!=</span> sortedNodeScoreList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>TotalScore <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>sortedNodeScoreList<span class="token punctuation">)</span> <span class="token operator">==</span> count <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &#x6700;&#x9AD8;&#x540C;&#x5206;&#x8282;&#x70B9;&#x7684;&#x9009;&#x62E9; &#x84C4;&#x6C34;&#x6C60;&#x62BD;&#x6837;&#x6CD5;</span>
        <span class="token keyword">if</span> ns<span class="token punctuation">.</span>TotalScore <span class="token operator">==</span> sortedNodeScoreList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>TotalScore <span class="token punctuation">{</span>
            <span class="token comment">// &#x6700;&#x9AD8;&#x5206;&#x540C;&#x5206;&#x8282;&#x70B9;&#x6570;&#x91CF;&#x8BA1;&#x6570;+1</span>
            cntOfMaxScore<span class="token operator">++</span>
            <span class="token keyword">if</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span>cntOfMaxScore<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token comment">// &#x540C;&#x5206;&#x8282;&#x70B9;&#x6709;1/cntOfMaxScore&#x7684;&#x6982;&#x7387;&#x66FF;&#x4EE3;&#x6700;&#x4F18;&#x8282;&#x70B9;</span>
                selectedIndex <span class="token operator">=</span> cntOfMaxScore <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        sortedNodeScoreList <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>sortedNodeScoreList<span class="token punctuation">,</span> ns<span class="token punctuation">)</span>
        <span class="token comment">// &#x5806;&#x4E3A;&#x7A7A;&#x65F6;&#x9000;&#x51FA;&#x5FAA;&#x73AF;</span>
        <span class="token keyword">if</span> h<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x5982;&#x679C;&#x6700;&#x9AD8;&#x5206;&#x540C;&#x5206;&#x8282;&#x70B9;&#x66FF;&#x6362;&#x4E86;0&#x53F7;&#x5143;&#x7D20;</span>
    <span class="token keyword">if</span> selectedIndex <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x5728;sortedNodeScoreList&#x4E2D;&#x4EA4;&#x6362;&#x5143;&#x7D20;&#x4F4D;&#x7F6E;</span>
        previous <span class="token operator">:=</span> sortedNodeScoreList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        sortedNodeScoreList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> sortedNodeScoreList<span class="token punctuation">[</span>selectedIndex<span class="token punctuation">]</span>
        sortedNodeScoreList<span class="token punctuation">[</span>selectedIndex<span class="token punctuation">]</span> <span class="token operator">=</span> previous
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x4FDD;&#x8BC1;&#x53EA;&#x6709;count&#x4E2A;&#x5143;&#x7D20;</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>sortedNodeScoreList<span class="token punctuation">)</span> <span class="token operator">&gt;</span> count <span class="token punctuation">{</span>
        sortedNodeScoreList <span class="token operator">=</span> sortedNodeScoreList<span class="token punctuation">[</span><span class="token punctuation">:</span>count<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x8FD4;&#x56DE;&#x7B2C;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x540D;&#x79F0;&#x548C;&#x6574;&#x4E2A;&#x5217;&#x8868;</span>
    <span class="token keyword">return</span> sortedNodeScoreList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span> sortedNodeScoreList<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>schedulePod()</code>&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7684;<code>ScheduleResult</code>&#x4E2D;&#x5305;&#x62EC;&#x6700;&#x540E;&#x8981;&#x5C1D;&#x8BD5;&#x7ED1;&#x5B9A;&#x7684;&#x8282;&#x70B9;<code>SuggestedHost</code>&#xFF0C;&#x672C;&#x6B21;&#x603B;&#x5171;&#x8BC4;&#x4F30;&#x8FC7;&#x7684;&#x8282;&#x70B9;&#x603B;&#x6570;<code>EvaluatedNodes</code>&#xFF0C;&#x5176;&#x503C;&#x662F;&#x8FC7;&#x6EE4;&#x9636;&#x6BB5;&#x8FD4;&#x56DE;&#x7684;<code>feasibleNodes</code>&#x957F;&#x5EA6;&#x4E0E;&#x5DF2;&#x77E5;&#x4E0D;&#x53EF;&#x8C03;&#x5EA6;&#x8282;&#x70B9;&#x5217;&#x8868;<code>NodeToStatus</code>&#x7684;&#x957F;&#x5EA6;&#x603B;&#x548C;&#xFF0C;&#x8FD8;&#x6709;&#x53EF;&#x7528;&#x8282;&#x70B9;&#x6570;&#x91CF;<code>FeasibleNodes</code>&#x3002;</p>
<pre class="language-"><code class="lang-go">    <span class="token keyword">return</span> ScheduleResult<span class="token punctuation">{</span>
        SuggestedHost<span class="token punctuation">:</span>  host<span class="token punctuation">,</span>
        EvaluatedNodes<span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>feasibleNodes<span class="token punctuation">)</span> <span class="token operator">+</span> diagnosis<span class="token punctuation">.</span>NodeToStatus<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        FeasibleNodes<span class="token punctuation">:</span>  <span class="token function">len</span><span class="token punctuation">(</span>feasibleNodes<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> err
</code></pre>
<h2 id="assume&#x9636;&#x6BB5;"><a name="assume&#x9636;&#x6BB5;" class="anchor-navigation-ex-anchor" href="#assume&#x9636;&#x6BB5;"><i class="fa fa-link" aria-hidden="true"></i></a>3. Assume&#x9636;&#x6BB5;</h2>
<p><code>ScheduleResult</code>&#x5BF9;&#x8C61;&#x8FD4;&#x56DE;&#x4EE5;&#x540E;&#xFF0C;<code>schedulingCycle()</code>&#x65B9;&#x6CD5;&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x903B;&#x8F91;&#x7EC8;&#x4E8E;&#x7ED3;&#x675F;&#x4E86;&#xFF0C;&#x5148;&#x4E0D;&#x7EA0;&#x7ED3;&#x4E8E;&#x5931;&#x8D25;&#x5904;&#x7406;&#xFF0C;&#x7EE7;&#x7EED;&#x5206;&#x6790;&#x6807;&#x51C6;&#x7684;&#x6210;&#x529F;&#x6D41;&#x7A0B;&#x3002;</p>
<p>&#x5728;<code>SchedulePod()</code>&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x4E86;&#x6210;&#x529F;&#x4EE5;&#x540E;&#xFF0C;<code>Kubernetes</code>&#x8C03;&#x5EA6;&#x5668;&#x5BF9;&#x6B64;&#x6709;&#x4E50;&#x89C2;&#x7684;&#x9884;&#x671F;&#xFF0C;&#x8BA4;&#x4E3A;&#x7ECF;&#x8FC7;&#x7CBE;&#x5BC6;&#x800C;&#x53C8;&#x4FDD;&#x5B88;&#x7684;&#x8BA1;&#x7B97;&#x903B;&#x8F91;&#x4EE5;&#x540E;&#xFF0C;&#x8FD9;&#x4E2A;Pod&#x6700;&#x7EC8;&#x4F1A;&#x88AB;&#x6210;&#x529F;&#x7ED1;&#x5B9A;&#xFF0C;&#x800C;&#x7ED1;&#x5B9A;&#x5468;&#x671F;&#x53C8;&#x662F;&#x5F02;&#x6B65;&#x8FDB;&#x884C;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6B64;&#x65F6;Pod&#x4F1A;&#x8FDB;&#x5165;&#x4E00;&#x4E2A;<code>Assumed</code>&#x7684;&#x4E2D;&#x95F4;&#x72B6;&#x6001;&#xFF0C;&#x5B83;&#x4F1A;&#x5B58;&#x5728;&#x4E8E;&#x8C03;&#x5EA6;&#x7F13;&#x5B58;<code>Cache</code>&#x4E2D;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sched <span class="token operator">*</span>Scheduler<span class="token punctuation">)</span> <span class="token function">schedulingCycle</span><span class="token punctuation">(</span>
    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
    state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span>
    fwk framework<span class="token punctuation">.</span>Framework<span class="token punctuation">,</span>
    podInfo <span class="token operator">*</span>framework<span class="token punctuation">.</span>QueuedPodInfo<span class="token punctuation">,</span>
    start time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span>
    podsToActivate <span class="token operator">*</span>framework<span class="token punctuation">.</span>PodsToActivate<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span>ScheduleResult<span class="token punctuation">,</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>QueuedPodInfo<span class="token punctuation">,</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    pod <span class="token operator">:=</span> podInfo<span class="token punctuation">.</span>Pod
    scheduleResult<span class="token punctuation">,</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span><span class="token function">SchedulePod</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fwk<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">)</span>
    <span class="token comment">// err&#x4E0D;&#x4E3A;&#x7A7A;&#x7684;&#x5904;&#x7406; &#x6682;&#x4E14;&#x5FFD;&#x7565;</span>
    <span class="token comment">// ......</span>
    <span class="token comment">// &#x6DF1;&#x62F7;&#x8D1D;PodInfo</span>
    assumedPodInfo <span class="token operator">:=</span> podInfo<span class="token punctuation">.</span><span class="token function">DeepCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    assumedPod <span class="token operator">:=</span> assumedPodInfo<span class="token punctuation">.</span>Pod
    <span class="token comment">// &#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x5BF9;Pod&#x7684;&#x9884;&#x671F;&#x72B6;&#x6001;&#x505A;&#x66F4;&#x65B0;</span>
    err <span class="token operator">=</span> sched<span class="token punctuation">.</span><span class="token function">assume</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>
    <span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8C03;&#x7528;<code>assume()</code>&#x65B9;&#x6CD5;&#x66F4;&#x65B0;&#x8C03;&#x5EA6;&#x7F13;&#x5B58;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x5176;&#x4E2D;&#x7684;<code>Cache.AssumePod()</code>&#x5728;&#x7B2C;&#x4E00;&#x7BC7;&#x8C03;&#x5EA6;&#x961F;&#x5217;&#x90E8;&#x5206;&#x6709;&#x8FC7;&#x7B80;&#x5355;&#x8BF4;&#x660E;&#xFF0C;&#x8FD9;&#x4E00;&#x6B65;&#x5B9E;&#x9645;&#x5C31;&#x662F;&#x66F4;&#x65B0;&#x7F13;&#x5B58;&#x4E00;&#x904D;&#x4E0B;&#x4E00;&#x4E2A;Pod&#x7684;&#x8BA1;&#x7B97;&#x80FD;&#x591F;&#x8003;&#x8651;&#x5230;&#x5904;&#x4E8E;<code>Assume</code>&#x72B6;&#x6001;&#x7684;Pod&#xFF0C;&#x4E0D;&#x81F3;&#x4E8E;&#x56E0;&#x4E3A;&#x8D44;&#x6E90;&#x51B2;&#x7A81;&#x5BFC;&#x81F4;&#x7ED1;&#x5B9A;&#x5931;&#x8D25;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sched <span class="token operator">*</span>Scheduler<span class="token punctuation">)</span> <span class="token function">assume</span><span class="token punctuation">(</span>logger klog<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> assumed <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> host <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x4FEE;&#x6539;NodeName&#x5B57;&#x6BB5;</span>
    assumed<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName <span class="token operator">=</span> host
    <span class="token comment">// &#x6DFB;&#x52A0;&#x5230;&#x8C03;&#x5EA6;&#x7F13;&#x5B58;&#x4E2D;</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> sched<span class="token punctuation">.</span>Cache<span class="token punctuation">.</span><span class="token function">AssumePod</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> assumed<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Scheduler cache AssumePod failed&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token comment">// if &quot;assumed&quot; is a nominated pod, we should remove it from internal cache</span>
    <span class="token keyword">if</span> sched<span class="token punctuation">.</span>SchedulingQueue <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x66F4;&#x65B0;&#x6E05;&#x9664;&#x63D0;&#x540D;&#x5668;&#x4E2D;&#x7684;&#x4FE1;&#x606F;</span>
        sched<span class="token punctuation">.</span>SchedulingQueue<span class="token punctuation">.</span><span class="token function">DeleteNominatedPodIfExists</span><span class="token punctuation">(</span>assumed<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="reserve&#x6269;&#x5C55;&#x70B9;"><a name="reserve&#x6269;&#x5C55;&#x70B9;" class="anchor-navigation-ex-anchor" href="#reserve&#x6269;&#x5C55;&#x70B9;"><i class="fa fa-link" aria-hidden="true"></i></a>4. Reserve&#x6269;&#x5C55;&#x70B9;</h2>
<p>&#x5728;<code>Assume</code>&#x9636;&#x6BB5;&#x540E;&#xFF0C;&#x8C03;&#x5EA6;&#x5468;&#x671F;&#x8FD8;&#x5269;&#x4E0B;&#x4E24;&#x4E2A;&#x6269;&#x5C55;&#x70B9;&#xFF0C;&#x6B64;&#x65F6;&#x5173;&#x4E8E;&#x8C03;&#x5EA6;&#x7684;&#x9009;&#x62E9;&#x5DF2;&#x7ECF;&#x7ED3;&#x675F;&#x4E86;&#xFF0C;&#x6240;&#x505A;&#x7684;&#x5185;&#x5BB9;&#x662F;&#x8981;&#x4E3A;&#x7ED1;&#x5B9A;&#x548C;&#x4E0B;&#x6B21;&#x8C03;&#x5EA6;&#x505A;&#x51C6;&#x5907;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x6269;&#x5C55;&#x70B9;&#x662F;&#x8D44;&#x6E90;&#x9884;&#x7559;<code>Reserve</code>&#x6269;&#x5C55;&#x70B9;&#x548C;&#x51C6;&#x5165;<code>Permit</code>&#x6269;&#x5C55;&#x70B9;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sched <span class="token operator">*</span>Scheduler<span class="token punctuation">)</span> <span class="token function">schedulingCycle</span><span class="token punctuation">(</span>
    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
    state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span>
    fwk framework<span class="token punctuation">.</span>Framework<span class="token punctuation">,</span>
    podInfo <span class="token operator">*</span>framework<span class="token punctuation">.</span>QueuedPodInfo<span class="token punctuation">,</span>
    start time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span>
    podsToActivate <span class="token operator">*</span>framework<span class="token punctuation">.</span>PodsToActivate<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span>ScheduleResult<span class="token punctuation">,</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>QueuedPodInfo<span class="token punctuation">,</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token comment">// Run the Reserve method of reserve plugins.</span>
    <span class="token keyword">if</span> sts <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">RunReservePluginsReserve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>sts<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// trigger un-reserve to clean up state associated with the reserved Pod</span>
        fwk<span class="token punctuation">.</span><span class="token function">RunReservePluginsUnreserve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>
        <span class="token keyword">if</span> forgetErr <span class="token operator">:=</span> sched<span class="token punctuation">.</span>Cache<span class="token punctuation">.</span><span class="token function">ForgetPod</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> assumedPod<span class="token punctuation">)</span><span class="token punctuation">;</span> forgetErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>forgetErr<span class="token punctuation">,</span> <span class="token string">&quot;Scheduler cache ForgetPod failed&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> sts<span class="token punctuation">.</span><span class="token function">IsRejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fitErr <span class="token operator">:=</span> <span class="token operator">&amp;</span>framework<span class="token punctuation">.</span>FitError<span class="token punctuation">{</span>
                NumAllNodes<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                Pod<span class="token punctuation">:</span>         pod<span class="token punctuation">,</span>
                Diagnosis<span class="token punctuation">:</span> framework<span class="token punctuation">.</span>Diagnosis<span class="token punctuation">{</span>
                    NodeToStatus<span class="token punctuation">:</span> framework<span class="token punctuation">.</span><span class="token function">NewDefaultNodeToStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            fitErr<span class="token punctuation">.</span>Diagnosis<span class="token punctuation">.</span>NodeToStatus<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">,</span> sts<span class="token punctuation">)</span>
            fitErr<span class="token punctuation">.</span>Diagnosis<span class="token punctuation">.</span><span class="token function">AddPluginStatus</span><span class="token punctuation">(</span>sts<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ScheduleResult<span class="token punctuation">{</span>nominatingInfo<span class="token punctuation">:</span> clearNominatedNode<span class="token punctuation">}</span><span class="token punctuation">,</span> assumedPodInfo<span class="token punctuation">,</span> framework<span class="token punctuation">.</span><span class="token function">NewStatus</span><span class="token punctuation">(</span>sts<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>fitErr<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ScheduleResult<span class="token punctuation">{</span>nominatingInfo<span class="token punctuation">:</span> clearNominatedNode<span class="token punctuation">}</span><span class="token punctuation">,</span> assumedPodInfo<span class="token punctuation">,</span> sts
    <span class="token punctuation">}</span>
    <span class="token comment">// Run &quot;permit&quot; plugins.</span>
    runPermitStatus <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">RunPermitPlugins</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>runPermitStatus<span class="token punctuation">.</span><span class="token function">IsWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>runPermitStatus<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// trigger un-reserve to clean up state associated with the reserved Pod</span>
        fwk<span class="token punctuation">.</span><span class="token function">RunReservePluginsUnreserve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> assumedPod<span class="token punctuation">,</span> scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">)</span>
        <span class="token keyword">if</span> forgetErr <span class="token operator">:=</span> sched<span class="token punctuation">.</span>Cache<span class="token punctuation">.</span><span class="token function">ForgetPod</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> assumedPod<span class="token punctuation">)</span><span class="token punctuation">;</span> forgetErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>forgetErr<span class="token punctuation">,</span> <span class="token string">&quot;Scheduler cache ForgetPod failed&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> runPermitStatus<span class="token punctuation">.</span><span class="token function">IsRejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fitErr <span class="token operator">:=</span> <span class="token operator">&amp;</span>framework<span class="token punctuation">.</span>FitError<span class="token punctuation">{</span>
                NumAllNodes<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                Pod<span class="token punctuation">:</span>         pod<span class="token punctuation">,</span>
                Diagnosis<span class="token punctuation">:</span> framework<span class="token punctuation">.</span>Diagnosis<span class="token punctuation">{</span>
                    NodeToStatus<span class="token punctuation">:</span> framework<span class="token punctuation">.</span><span class="token function">NewDefaultNodeToStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            fitErr<span class="token punctuation">.</span>Diagnosis<span class="token punctuation">.</span>NodeToStatus<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">,</span> runPermitStatus<span class="token punctuation">)</span>
            fitErr<span class="token punctuation">.</span>Diagnosis<span class="token punctuation">.</span><span class="token function">AddPluginStatus</span><span class="token punctuation">(</span>runPermitStatus<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ScheduleResult<span class="token punctuation">{</span>nominatingInfo<span class="token punctuation">:</span> clearNominatedNode<span class="token punctuation">}</span><span class="token punctuation">,</span> assumedPodInfo<span class="token punctuation">,</span> framework<span class="token punctuation">.</span><span class="token function">NewStatus</span><span class="token punctuation">(</span>runPermitStatus<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>fitErr<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> ScheduleResult<span class="token punctuation">{</span>nominatingInfo<span class="token punctuation">:</span> clearNominatedNode<span class="token punctuation">}</span><span class="token punctuation">,</span> assumedPodInfo<span class="token punctuation">,</span> runPermitStatus
    <span class="token punctuation">}</span>

    <span class="token comment">// At the end of a successful scheduling cycle, pop and move up Pods if needed.</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>podsToActivate<span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        sched<span class="token punctuation">.</span>SchedulingQueue<span class="token punctuation">.</span><span class="token function">Activate</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> podsToActivate<span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
        <span class="token comment">// Clear the entries after activation.</span>
        podsToActivate<span class="token punctuation">.</span>Map <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> scheduleResult<span class="token punctuation">,</span> assumedPodInfo<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E0B;&#x9762;&#x770B;&#x8D44;&#x6E90;&#x9884;&#x7559;&#x7684;&#x903B;&#x8F91;<code>RunReservePluginsReserve()</code>&#x548C;<code>runReservePluginReserve()</code>&#x65B9;&#x6CD5;&#xFF0C;&#x5916;&#x5C42;&#x548C;&#x4E4B;&#x524D;&#x7684;&#x51E0;&#x4E2A;<code>RunXXXPlugin()</code>&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>frameworkImpl<span class="token punctuation">)</span> <span class="token function">RunReservePluginsReserve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>status <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        metrics<span class="token punctuation">.</span>FrameworkExtensionPointDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>Reserve<span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>profileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    verboseLogs <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> verboseLogs <span class="token punctuation">{</span>
        logger <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithName</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> <span class="token string">&quot;Reserve&quot;</span><span class="token punctuation">)</span>
        logger <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithValues</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span>ObjectRef<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> nodeName<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pl <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>reservePlugins <span class="token punctuation">{</span>
        ctx <span class="token operator">:=</span> ctx
        <span class="token keyword">if</span> verboseLogs <span class="token punctuation">{</span>
            logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithName</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            ctx <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        status <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">runReservePluginReserve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> status<span class="token punctuation">.</span><span class="token function">IsRejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Pod rejected by plugin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;plugin&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                status<span class="token punctuation">.</span><span class="token function">SetPlugin</span><span class="token punctuation">(</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> status
            <span class="token punctuation">}</span>
            err <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Plugin failed&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;plugin&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;running Reserve plugin %q: %w&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>frameworkImpl<span class="token punctuation">)</span> <span class="token function">runReservePluginReserve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> pl framework<span class="token punctuation">.</span>ReservePlugin<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">ShouldRecordPluginMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pl<span class="token punctuation">.</span><span class="token function">Reserve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    status <span class="token operator">:=</span> pl<span class="token punctuation">.</span><span class="token function">Reserve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>metricsRecorder<span class="token punctuation">.</span><span class="token function">ObservePluginDurationAsync</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>Reserve<span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> status
<span class="token punctuation">}</span>
</code></pre>
<p>&#x90A3;&#x4E48;&#x770B;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x8D44;&#x6E90;&#x9884;&#x7559;&#x63D2;&#x4EF6;<code>VolumeBinding</code>&#x5B9E;&#x73B0;&#xFF0C;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pl <span class="token operator">*</span>VolumeBinding<span class="token punctuation">)</span> <span class="token function">Reserve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cs <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status <span class="token punctuation">{</span>
    <span class="token comment">// &#x4ECE;CycleState&#x4E2D;&#x83B7;&#x53D6;&#x4FE1;&#x606F;</span>
    state<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getStateData</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// we don&apos;t need to hold the lock as only one node will be reserved for the given pod</span>
    podVolumes<span class="token punctuation">,</span> ok <span class="token operator">:=</span> state<span class="token punctuation">.</span>podVolumesByNode<span class="token punctuation">[</span>nodeName<span class="token punctuation">]</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        allBound<span class="token punctuation">,</span> err <span class="token operator">:=</span> pl<span class="token punctuation">.</span>Binder<span class="token punctuation">.</span><span class="token function">AssumePodVolumes</span><span class="token punctuation">(</span>klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">,</span> podVolumes<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &#x6709;&#x5377;&#x9700;&#x8981;&#x7ED1;&#x5B9A;&#x65F6; &#x503C;&#x8BBE;&#x7F6E;&#x4E3A;allBound&#x8FD4;&#x56DE;&#x7684;bool&#x503C;</span>
        state<span class="token punctuation">.</span>allBound <span class="token operator">=</span> allBound
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x6CA1;&#x6709;&#x5377;&#x9700;&#x8981;&#x7ED1;&#x5B9A;&#x65F6; &#x503C;&#x76F4;&#x63A5;&#x8BBE;&#x7F6E;&#x4E3A;true</span>
        state<span class="token punctuation">.</span>allBound <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5176;&#x4E2D;&#x8C03;&#x7528;&#x4E86;<code>AssumePodVolumes()</code>&#x65B9;&#x6CD5;&#xFF0C;&#x66F4;&#x65B0;&#x4E86;<code>AssumeCache</code>&#x7F13;&#x5B58;&#x548C;&#x539F;<code>PodVolumes</code>&#x5BF9;&#x8C61;&#x4E2D;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5176;&#x4E2D;&#x7684;<code>pvcCache</code>&#x3001;<code>pvcCache</code>&#x548C;Pod&#x7684;<code>Assume</code>&#x539F;&#x7406;&#x7C7B;&#x4F3C;&#xFF0C;&#x90FD;&#x662F;&#x5BF9;&#x9884;&#x671F;&#x5C06;&#x4F1A;&#x5B58;&#x5728;&#x7684;&#x5BF9;&#x8C61;&#x505A;&#x4E00;&#x4EFD;&#x5728;&#x7F13;&#x5B58;&#x4E2D;&#x7684;&#x8BB0;&#x5F55;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// AssumePodVolumes will take the matching PVs and PVCs to provision in pod&apos;s</span>
<span class="token comment">// volume information for the chosen node, and:</span>
<span class="token comment">// 1. Update the pvCache with the new prebound PV.</span>
<span class="token comment">// 2. Update the pvcCache with the new PVCs with annotations set</span>
<span class="token comment">// 3. Update PodVolumes again with cached API updates for PVs and PVCs.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>volumeBinder<span class="token punctuation">)</span> <span class="token function">AssumePodVolumes</span><span class="token punctuation">(</span>logger klog<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> assumedPod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">,</span> podVolumes <span class="token operator">*</span>PodVolumes<span class="token punctuation">)</span> <span class="token punctuation">(</span>allFullyBound <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;AssumePodVolumes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KRef</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            metrics<span class="token punctuation">.</span>VolumeSchedulingStageFailed<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span><span class="token string">&quot;assume&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// &#x68C0;&#x67E5;Pod&#x9700;&#x8981;&#x7684;&#x6240;&#x6709;&#x5377;&#x662F;&#x5426;&#x90FD;&#x5DF2;&#x7ECF;&#x88AB;&#x7ED1;&#x5B9A;</span>
    <span class="token comment">// &#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x7ED1;&#x5B9A;&#x4E86;&#x5C31;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span>
    <span class="token keyword">if</span> allBound <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">arePodVolumesBound</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> assumedPod<span class="token punctuation">)</span><span class="token punctuation">;</span> allBound <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;AssumePodVolumes: all PVCs bound and nothing to do&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KRef</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x9759;&#x6001;&#x5377;&#x9884;&#x5360; PV</span>
    newBindings <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>BindingInfo<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> binding <span class="token operator">:=</span> <span class="token keyword">range</span> podVolumes<span class="token punctuation">.</span>StaticBindings <span class="token punctuation">{</span>
        newPV<span class="token punctuation">,</span> dirty<span class="token punctuation">,</span> err <span class="token operator">:=</span> volume<span class="token punctuation">.</span><span class="token function">GetBindVolumeToClaim</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>pv<span class="token punctuation">,</span> binding<span class="token punctuation">.</span>pvc<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;AssumePodVolumes: GetBindVolumeToClaim&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>assumedPod<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;PV&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>pv<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;PVC&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>pvc<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;newPV&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>newPV<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;dirty&quot;</span><span class="token punctuation">,</span> dirty<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;AssumePodVolumes: fail to GetBindVolumeToClaim&quot;</span><span class="token punctuation">)</span>
            b<span class="token punctuation">.</span><span class="token function">revertAssumedPVs</span><span class="token punctuation">(</span>newBindings<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO: can we assume every time?</span>
        <span class="token keyword">if</span> dirty <span class="token punctuation">{</span>
            <span class="token comment">// &#x7F13;&#x5B58;&#x66F4;&#x65B0;</span>
            err <span class="token operator">=</span> b<span class="token punctuation">.</span>pvCache<span class="token punctuation">.</span><span class="token function">Assume</span><span class="token punctuation">(</span>newPV<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">revertAssumedPVs</span><span class="token punctuation">(</span>newBindings<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        newBindings <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>newBindings<span class="token punctuation">,</span> <span class="token operator">&amp;</span>BindingInfo<span class="token punctuation">{</span>pv<span class="token punctuation">:</span> newPV<span class="token punctuation">,</span> pvc<span class="token punctuation">:</span> binding<span class="token punctuation">.</span>pvc<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x52A8;&#x6001;&#x5377;&#x9884;&#x5360; PVC</span>
    newProvisionedPVCs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>PersistentVolumeClaim<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> claim <span class="token operator">:=</span> <span class="token keyword">range</span> podVolumes<span class="token punctuation">.</span>DynamicProvisions <span class="token punctuation">{</span>
        <span class="token comment">// The claims from method args can be pointing to watcher cache. We must not</span>
        <span class="token comment">// modify these, therefore create a copy.</span>
        claimClone <span class="token operator">:=</span> claim<span class="token punctuation">.</span><span class="token function">DeepCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        metav1<span class="token punctuation">.</span><span class="token function">SetMetaDataAnnotation</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>claimClone<span class="token punctuation">.</span>ObjectMeta<span class="token punctuation">,</span> volume<span class="token punctuation">.</span>AnnSelectedNode<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>
        <span class="token comment">// &#x7F13;&#x5B58;&#x66F4;&#x65B0;</span>
        err <span class="token operator">=</span> b<span class="token punctuation">.</span>pvcCache<span class="token punctuation">.</span><span class="token function">Assume</span><span class="token punctuation">(</span>claimClone<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span><span class="token function">revertAssumedPVs</span><span class="token punctuation">(</span>newBindings<span class="token punctuation">)</span>
            b<span class="token punctuation">.</span><span class="token function">revertAssumedPVCs</span><span class="token punctuation">(</span>newProvisionedPVCs<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        newProvisionedPVCs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>newProvisionedPVCs<span class="token punctuation">,</span> claimClone<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// PodVolumes&#x5BF9;&#x8C61;&#x66F4;&#x65B0;</span>
    podVolumes<span class="token punctuation">.</span>StaticBindings <span class="token operator">=</span> newBindings
    podVolumes<span class="token punctuation">.</span>DynamicProvisions <span class="token operator">=</span> newProvisionedPVCs
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x5931;&#x8D25;&#x540E;&#x7684;&#x72B6;&#x6001;&#x56DE;&#x6EDA;"><a name="&#x5931;&#x8D25;&#x540E;&#x7684;&#x72B6;&#x6001;&#x56DE;&#x6EDA;" class="anchor-navigation-ex-anchor" href="#&#x5931;&#x8D25;&#x540E;&#x7684;&#x72B6;&#x6001;&#x56DE;&#x6EDA;"><i class="fa fa-link" aria-hidden="true"></i></a>4.1. &#x5931;&#x8D25;&#x540E;&#x7684;&#x72B6;&#x6001;&#x56DE;&#x6EDA;</h3>
<p>&#x4ECD;&#x4EE5;<code>VolumeBinding</code>&#x4E3A;&#x4F8B;&#xFF0C;&#x5931;&#x8D25;&#x540E;&#x7684;<code>Unreserve</code>&#x63D2;&#x4EF6;&#x83B7;&#x53D6;&#x8C03;&#x5EA6;&#x5F00;&#x59CB;&#x65F6;&#x4ECE;<code>ApiServer</code>&#x4E2D;&#x83B7;&#x53D6;&#x5230;&#x7684;&#x5BF9;&#x8C61;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x501F;&#x52A9;<code>Restore()</code>&#x65B9;&#x6CD5;&#x5411;<code>FIFO</code>&#x4E2D;&#x53D1;&#x9001;&#x66F4;&#x65B0;&#x4E8B;&#x4EF6;&#xFF0C;&#x4F7F;&#x672C;&#x5730;&#x7F13;&#x5B58;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x56DE;&#x6EDA;&#x5230;&#x6700;&#x521D;&#x72B6;&#x6001;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>frameworkImpl<span class="token punctuation">)</span> <span class="token function">runReservePluginUnreserve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> pl framework<span class="token punctuation">.</span>ReservePlugin<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">ShouldRecordPluginMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pl<span class="token punctuation">.</span><span class="token function">Unreserve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    pl<span class="token punctuation">.</span><span class="token function">Unreserve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>metricsRecorder<span class="token punctuation">.</span><span class="token function">ObservePluginDurationAsync</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>Unreserve<span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> framework<span class="token punctuation">.</span>Success<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pl <span class="token operator">*</span>VolumeBinding<span class="token punctuation">)</span> <span class="token function">Unreserve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cs <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getStateData</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// we don&apos;t need to hold the lock as only one node may be unreserved</span>
    podVolumes<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>podVolumesByNode<span class="token punctuation">[</span>nodeName<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    pl<span class="token punctuation">.</span>Binder<span class="token punctuation">.</span><span class="token function">RevertAssumedPodVolumes</span><span class="token punctuation">(</span>podVolumes<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>volumeBinder<span class="token punctuation">)</span> <span class="token function">RevertAssumedPodVolumes</span><span class="token punctuation">(</span>podVolumes <span class="token operator">*</span>PodVolumes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span><span class="token function">revertAssumedPVs</span><span class="token punctuation">(</span>podVolumes<span class="token punctuation">.</span>StaticBindings<span class="token punctuation">)</span>
    b<span class="token punctuation">.</span><span class="token function">revertAssumedPVCs</span><span class="token punctuation">(</span>podVolumes<span class="token punctuation">.</span>DynamicProvisions<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>volumeBinder<span class="token punctuation">)</span> <span class="token function">revertAssumedPVs</span><span class="token punctuation">(</span>bindings <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>BindingInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> BindingInfo <span class="token operator">:=</span> <span class="token keyword">range</span> bindings <span class="token punctuation">{</span>
        b<span class="token punctuation">.</span>pvCache<span class="token punctuation">.</span><span class="token function">Restore</span><span class="token punctuation">(</span>BindingInfo<span class="token punctuation">.</span>pv<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>AssumeCache<span class="token punctuation">)</span> <span class="token function">Restore</span><span class="token punctuation">(</span>objName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> c<span class="token punctuation">.</span><span class="token function">emitEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>rwMutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>rwMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    objInfo<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">getObjInfo</span><span class="token punctuation">(</span>objName<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// This could be expected if object got deleted</span>
        c<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Restore object&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>description<span class="token punctuation">,</span> <span class="token string">&quot;cacheKey&quot;</span><span class="token punctuation">,</span> objName<span class="token punctuation">,</span> <span class="token string">&quot;err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> objInfo<span class="token punctuation">.</span>latestObj <span class="token operator">!=</span> objInfo<span class="token punctuation">.</span>apiObj <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">pushEvent</span><span class="token punctuation">(</span>objInfo<span class="token punctuation">.</span>latestObj<span class="token punctuation">,</span> objInfo<span class="token punctuation">.</span>apiObj<span class="token punctuation">)</span>
            objInfo<span class="token punctuation">.</span>latestObj <span class="token operator">=</span> objInfo<span class="token punctuation">.</span>apiObj
        <span class="token punctuation">}</span>
        c<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Restored object&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>description<span class="token punctuation">,</span> <span class="token string">&quot;cacheKey&quot;</span><span class="token punctuation">,</span> objName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x7136;&#x540E;&#x8C03;&#x7528;<code>Cache.ForgetPod()</code>&#x65B9;&#x6CD5;&#xFF0C;&#x628A;Pod&#x7684;&#x4FE1;&#x606F;&#x4ECE;&#x672C;&#x5730;&#x7F13;&#x5B58;&#x7684;<code>cache.podStates</code>&#x4EE5;&#x53CA;<code>cache.assumedPods</code>&#x96C6;&#x5408;&#x4E2D;&#x5220;&#x9664;&#x3002;<code>Permit</code>&#x6269;&#x5C55;&#x70B9;&#x7684;&#x5931;&#x8D25;&#x5904;&#x7406;&#x4E0E;&#x4E4B;&#x5B8C;&#x5168;&#x76F8;&#x540C;&#x3002;</p>
<h2 id="permit&#x6269;&#x5C55;&#x70B9;"><a name="permit&#x6269;&#x5C55;&#x70B9;" class="anchor-navigation-ex-anchor" href="#permit&#x6269;&#x5C55;&#x70B9;"><i class="fa fa-link" aria-hidden="true"></i></a>5. Permit&#x6269;&#x5C55;&#x70B9;</h2>
<p><code>Reserve</code>&#x6269;&#x5C55;&#x70B9;&#x4E4B;&#x540E;&#x7D27;&#x63A5;&#x7740;&#x5C31;&#x662F;<code>Permit</code>&#x6269;&#x5C55;&#x70B9;&#xFF0C;&#x901A;&#x8FC7;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x5728;&#x6267;&#x884C;&#x5B8C;&#x5177;&#x4F53;&#x63D2;&#x4EF6;&#x4E4B;&#x540E;&#x4F1A;&#x5BF9;&#x8FD4;&#x56DE;&#x7684;&#x72B6;&#x6001;<code>status</code>&#x505A;&#x51FA;&#x5224;&#x65AD;&#xFF0C;&#x8FD9;&#x91CC;&#x548C;&#x5176;&#x4ED6;&#x63D2;&#x4EF6;&#x8FD4;&#x56DE;&#x72B6;&#x6001;&#x76F8;&#x6BD4;&#xFF0C;&#x591A;&#x4E86;&#x4E00;&#x4E2A;<code>Wait</code>&#x72B6;&#x6001;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8FD4;&#x56DE;<code>Success</code>&#x800C;&#x662F;<code>Wait</code>&#x65F6;&#xFF0C;&#x6839;&#x636E;&#x8FD4;&#x56DE;&#x503C;&#x8BBE;&#x7F6E;&#x63D2;&#x4EF6;&#x7B49;&#x5F85;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x957F;(&#x6700;&#x5927;&#x4E0D;&#x8D85;&#x8FC7;<code>15&#x5206;&#x949F;</code>)&#xFF0C;&#x5E76;&#x4FEE;&#x6539;<code>statusCode</code>&#x6807;&#x8BC6;&#x4F4D;&#xFF0C;&#x5728;&#x904D;&#x5386;&#x6267;&#x884C;&#x5B8C;&#x6240;&#x6709;&#x7684;&#x63D2;&#x4EF6;&#x4E4B;&#x540E;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x9700;&#x8981;&#x7B49;&#x5F85;&#x7684;&#xFF0C;&#x5C31;&#x5C06;&#x5176;&#x52A0;&#x5165;&#x5230;&#x7B49;&#x5F85;&#x961F;&#x5217;&#x4E2D;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>frameworkImpl<span class="token punctuation">)</span> <span class="token function">RunPermitPlugins</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> state <span class="token operator">*</span>framework<span class="token punctuation">.</span>CycleState<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>status <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        metrics<span class="token punctuation">.</span>FrameworkExtensionPointDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>Permit<span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>profileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    pluginsWaitTime <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>
    statusCode <span class="token operator">:=</span> framework<span class="token punctuation">.</span>Success
    logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    verboseLogs <span class="token operator">:=</span> logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> verboseLogs <span class="token punctuation">{</span>
        logger <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithName</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> <span class="token string">&quot;Permit&quot;</span><span class="token punctuation">)</span>
        logger <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithValues</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span>ObjectRef<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> nodeName<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pl <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>permitPlugins <span class="token punctuation">{</span>
        ctx <span class="token operator">:=</span> ctx
        <span class="token keyword">if</span> verboseLogs <span class="token punctuation">{</span>
            logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">LoggerWithName</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            ctx <span class="token operator">=</span> klog<span class="token punctuation">.</span><span class="token function">NewContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        status<span class="token punctuation">,</span> timeout <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">runPermitPlugin</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pl<span class="token punctuation">,</span> state<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> nodeName<span class="token punctuation">)</span>
        <span class="token comment">// &#x8FD4;&#x56DE;&#x72B6;&#x6001;&#x5224;&#x65AD;</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> status<span class="token punctuation">.</span><span class="token function">IsRejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Pod rejected by plugin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;plugin&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">WithPlugin</span><span class="token punctuation">(</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> status<span class="token punctuation">.</span><span class="token function">IsWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// &#x8FD4;&#x56DE;&#x72B6;&#x6001;&#x662F;Wait &#x8BBE;&#x7F6E;&#x8D85;&#x65F6;&#x65F6;&#x95F4;</span>
                <span class="token comment">// &#x6700;&#x5927;&#x662F;15&#x5206;&#x949F;</span>
                <span class="token keyword">if</span> timeout <span class="token operator">&gt;</span> maxTimeout <span class="token punctuation">{</span>
                    timeout <span class="token operator">=</span> maxTimeout
                <span class="token punctuation">}</span>
                <span class="token comment">// &#x8BBE;&#x7F6E;&#x63D2;&#x4EF6;&#x7B49;&#x5F85;&#x8D85;&#x65F6;&#x65F6;&#x957F;&#x5E76;&#x4FEE;&#x6539;&#x6807;statusCode&#x8BC6;&#x4F4D;</span>
                pluginsWaitTime<span class="token punctuation">[</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> timeout
                statusCode <span class="token operator">=</span> framework<span class="token punctuation">.</span>Wait
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                err <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Plugin failed&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;plugin&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;running Permit plugin %q: %w&quot;</span><span class="token punctuation">,</span> pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithPlugin</span><span class="token punctuation">(</span>pl<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x5982;&#x679C;&#x904D;&#x5386;&#x7ED3;&#x675F;&#x540E;&#x6700;&#x7EC8;&#x72B6;&#x6001;&#x662F;Wait</span>
    <span class="token keyword">if</span> statusCode <span class="token operator">==</span> framework<span class="token punctuation">.</span>Wait <span class="token punctuation">{</span>
        waitingPod <span class="token operator">:=</span> <span class="token function">newWaitingPod</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> pluginsWaitTime<span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>waitingPods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>waitingPod<span class="token punctuation">)</span>
        msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;one or more plugins asked to wait and no plugin rejected pod %q&quot;</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;One or more plugins asked to wait and no plugin rejected pod&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> framework<span class="token punctuation">.</span><span class="token function">NewStatus</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>Wait<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5728;<code>frameworkImpl</code>&#x4E2D;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x7B49;&#x5F85;&#x961F;&#x5217;<code>waitingPods</code>&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x5176;&#x7C7B;&#x578B;&#x662F;<code>waitingPodsMap</code>&#xFF0C;&#x7531;<code>waitingPod</code>&#x7684;&#x96C6;&#x5408;&#x548C;&#x4E00;&#x4E2A;&#x8BFB;&#x5199;&#x9501;&#x7EC4;&#x6210;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> waitingPodsMap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    pods <span class="token keyword">map</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>UID<span class="token punctuation">]</span><span class="token operator">*</span>waitingPod
    mu   sync<span class="token punctuation">.</span>RWMutex
<span class="token punctuation">}</span>

<span class="token keyword">type</span> waitingPod <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    pod            <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod
    <span class="token comment">// &#x5B9A;&#x65F6;&#x5668;</span>
    pendingPlugins <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Timer
    <span class="token comment">// &#x63A5;&#x6536;&#x7ED3;&#x679C;</span>
    s              <span class="token keyword">chan</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status
    mu             sync<span class="token punctuation">.</span>RWMutex
<span class="token punctuation">}</span>
</code></pre>
<p>&#x8FD9;&#x91CC;&#x5F88;&#x597D;&#x7406;&#x89E3;&#x4E86;&#xFF0C;&#x5C31;&#x662F;&#x7EC4;&#x88C5;&#x4E00;&#x4E2A;<code>waitingPod</code>&#x7ED3;&#x6784;&#xFF0C;&#x4E3A;&#x6BCF;&#x4E2A;&#x5176;&#x4E2D;&#x8981;&#x7B49;&#x5F85;&#x7684;&#x63D2;&#x4EF6;&#x8BBE;&#x7F6E;&#x4E00;&#x4E0B;&#x5B9A;&#x65F6;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x628A;&#x8FD9;&#x4E2A;<code>waitingPod</code>&#x5BF9;&#x8C61;&#x52A0;&#x5165;&#x96C6;&#x5408;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x65F6;&#x95F4;&#x5230;&#x4E86;&#x5C31;&#x4F1A;&#x81EA;&#x52A8;&#x6267;&#x884C;<code>Reject()</code>&#x65B9;&#x6CD5;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">newWaitingPod</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> pluginsMaxWaitTime <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token operator">*</span>waitingPod <span class="token punctuation">{</span>
    <span class="token comment">// &#x7EC4;&#x88C5;waitingPod&#x7ED3;&#x6784;</span>
    wp <span class="token operator">:=</span> <span class="token operator">&amp;</span>waitingPod<span class="token punctuation">{</span>
        pod<span class="token punctuation">:</span> pod<span class="token punctuation">,</span>
        s<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    wp<span class="token punctuation">.</span>pendingPlugins <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Timer<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pluginsMaxWaitTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
    wp<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> wp<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// &#x904D;&#x5386;&#x7B49;&#x5F85;&#x7ED3;&#x679C;&#x7684;&#x63D2;&#x4EF6; &#x5206;&#x522B;&#x8BBE;&#x7F6E;&#x5B9A;&#x65F6;&#x5668;</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> pluginsMaxWaitTime <span class="token punctuation">{</span>
        plugin<span class="token punctuation">,</span> waitTime <span class="token operator">:=</span> k<span class="token punctuation">,</span> v
        wp<span class="token punctuation">.</span>pendingPlugins<span class="token punctuation">[</span>plugin<span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;rejected due to timeout after waiting %v at plugin %v&quot;</span><span class="token punctuation">,</span>
                waitTime<span class="token punctuation">,</span> plugin<span class="token punctuation">)</span>
            <span class="token comment">// &#x5982;&#x679C;&#x8D85;&#x65F6;&#x4F1A;&#x6267;&#x884C;Reject&#x65B9;&#x6CD5;</span>
            wp<span class="token punctuation">.</span><span class="token function">Reject</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> wp
<span class="token punctuation">}</span>
</code></pre>
<p>&#x5982;&#x679C;&#x63D2;&#x4EF6;&#x8FD4;&#x56DE;&#x6210;&#x529F;&#x4F1A;&#x8C03;&#x7528;<code>Allow()</code>&#x65B9;&#x6CD5;&#xFF0C;&#x4ECE;<code>pendingPlugins</code>&#x7684;&#x96C6;&#x5408;&#x4E2D;&#x83B7;&#x53D6;&#x63D2;&#x4EF6;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x7136;&#x540E;&#x505C;&#x6B62;&#x5B9A;&#x65F6;&#x5668;&#x5E76;&#x5220;&#x9664;&#x5F53;&#x524D;&#x5143;&#x7D20;&#x3002;&#x901A;&#x8FC7;&#x5BF9;&#x96C6;&#x5408;&#x957F;&#x5EA6;&#x7684;&#x5224;&#x65AD;&#xFF0C;&#x5728;&#x957F;&#x5EA6;&#x4E3A;0&#x65F6;&#x8868;&#x793A;&#x6240;&#x6709;&#x7684;<code>Permit</code>&#x63D2;&#x4EF6;&#x90FD;&#x5DF2;&#x7ECF;&#x5141;&#x8BB8;&#x8FD9;&#x4E2A;Pod&#x7684;&#x8C03;&#x5EA6;&#x4E86;&#xFF0C;&#x5C31;&#x5411;<code>waitingPod</code>&#x7684;<code>s</code>&#x901A;&#x9053;&#x4E2D;&#x53D1;&#x9001;&#x4E00;&#x4E2A;<code>framework.Success</code>&#x7684;&#x4FE1;&#x53F7;&#xFF0C;&#x8BE5;&#x4FE1;&#x53F7;&#x4F1A;&#x5728;&#x7ED1;&#x5B9A;&#x5468;&#x671F;&#x88AB;&#x63A5;&#x6536;&#x5E76;&#x5224;&#x65AD;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>waitingPod<span class="token punctuation">)</span> <span class="token function">Allow</span><span class="token punctuation">(</span>pluginName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    w<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> w<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> timer<span class="token punctuation">,</span> exist <span class="token operator">:=</span> w<span class="token punctuation">.</span>pendingPlugins<span class="token punctuation">[</span>pluginName<span class="token punctuation">]</span><span class="token punctuation">;</span> exist <span class="token punctuation">{</span>
        <span class="token comment">// &#x505C;&#x6B62;&#x5F53;&#x524D;&#x5B9A;&#x65F6;&#x5668;</span>
        timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// &#x4ECE;&#x63D2;&#x4EF6;&#x5217;&#x8868;&#x4E2D;&#x5220;&#x9664;&#x5F53;&#x524D;&#x63D2;&#x4EF6;</span>
        <span class="token function">delete</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>pendingPlugins<span class="token punctuation">,</span> pluginName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x8FD8;&#x9700;&#x8981;&#x7B49;&#x5F85;&#x5176;&#x4ED6;&#x63D2;&#x4EF6;&#x7684;&#x7ED3;&#x679C;</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>pendingPlugins<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// pendingPlugins&#x4E2D;&#x5DF2;&#x7ECF;&#x6CA1;&#x6709;&#x5143;&#x7D20;&#x4E86; &#x5411;channel&#x4E2D;&#x53D1;&#x9001;&#x6210;&#x529F;&#x4FE1;&#x53F7;</span>
    <span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> w<span class="token punctuation">.</span>s <span class="token operator">&lt;-</span> framework<span class="token punctuation">.</span><span class="token function">NewStatus</span><span class="token punctuation">(</span>framework<span class="token punctuation">.</span>Success<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>Permit</code>&#x6269;&#x5C55;&#x70B9;&#x8FD0;&#x884C;&#x4E4B;&#x540E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5728;&#x6574;&#x4E2A;<code>SchedulingCycle</code>&#x7ED3;&#x675F;&#x4E4B;&#x524D;&#xFF0C;&#x4F1A;&#x6FC0;&#x6D3B;<code>podsToActivate</code>&#x96C6;&#x5408;&#x4E2D;&#x7684;Pod&#xFF0C;&#x628A;&#x5B83;&#x4EEC;&#x91CD;&#x65B0;&#x52A0;&#x5165;&#x5230;<code>ActiveQ</code>&#x91CC;&#xFF0C;&#x4E3A;&#x4E0B;&#x4E00;&#x6B21;&#x8C03;&#x5EA6;&#x7684;<code>SchedulingCycle</code>&#x505A;&#x597D;&#x51C6;&#x5907;&#x3002;</p>
<pre class="language-"><code class="lang-go">    <span class="token comment">// At the end of a successful scheduling cycle, pop and move up Pods if needed.</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>podsToActivate<span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        sched<span class="token punctuation">.</span>SchedulingQueue<span class="token punctuation">.</span><span class="token function">Activate</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> podsToActivate<span class="token punctuation">.</span>Map<span class="token punctuation">)</span>
        <span class="token comment">// Clear the entries after activation.</span>
        podsToActivate<span class="token punctuation">.</span>Map <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> scheduleResult<span class="token punctuation">,</span> assumedPodInfo<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="permit&#x6269;&#x5C55;&#x70B9;&#x7684;&#x5EF6;&#x4F38;"><a name="permit&#x6269;&#x5C55;&#x70B9;&#x7684;&#x5EF6;&#x4F38;" class="anchor-navigation-ex-anchor" href="#permit&#x6269;&#x5C55;&#x70B9;&#x7684;&#x5EF6;&#x4F38;"><i class="fa fa-link" aria-hidden="true"></i></a>5.1. Permit&#x6269;&#x5C55;&#x70B9;&#x7684;&#x5EF6;&#x4F38;</h3>
<p>&#x5728;&#x8C03;&#x5EA6;&#x5468;&#x671F;&#x4E2D;&#xFF0C;<code>Permit</code>&#x9636;&#x6BB5;&#x5982;&#x679C;&#x8FD4;&#x56DE;&#x7684;&#x662F;<code>Wait</code>&#x72B6;&#x6001;&#xFF0C;&#x8C03;&#x5EA6;&#x5668;&#x4E0D;&#x4F1A;&#x56E0;&#x4E3A;&#x7B49;&#x5F85;&#x5B83;&#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;&#x800C;&#x53BB;&#x5F71;&#x54CD;&#x5176;&#x4ED6;Pod&#x8C03;&#x5EA6;&#x7684;&#x6548;&#x7387;&#xFF0C;&#x800C;&#x662F;&#x5728;&#x5F02;&#x6B65;&#x6267;&#x884C;&#x7ED1;&#x5B9A;&#x5468;&#x671F;<code>BindingCycle</code>&#x7684;&#x5F00;&#x59CB;&#x5904;&#x786E;&#x8BA4;<code>waitingPod</code>&#x7684;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x662F;<code>Success</code>&#x8FD8;&#x662F;<code>Rejected</code>&#x3002;</p>
<pre class="language-"><code class="lang-go">    <span class="token comment">// Run &quot;permit&quot; plugins.</span>
    <span class="token keyword">if</span> status <span class="token operator">:=</span> fwk<span class="token punctuation">.</span><span class="token function">WaitOnPermit</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> assumedPod<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> status<span class="token punctuation">.</span><span class="token function">IsRejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fitErr <span class="token operator">:=</span> <span class="token operator">&amp;</span>framework<span class="token punctuation">.</span>FitError<span class="token punctuation">{</span>
                NumAllNodes<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                Pod<span class="token punctuation">:</span>         assumedPodInfo<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>
                Diagnosis<span class="token punctuation">:</span> framework<span class="token punctuation">.</span>Diagnosis<span class="token punctuation">{</span>
                    NodeToStatus<span class="token punctuation">:</span>         framework<span class="token punctuation">.</span><span class="token function">NewDefaultNodeToStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    UnschedulablePlugins<span class="token punctuation">:</span> sets<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Plugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            fitErr<span class="token punctuation">.</span>Diagnosis<span class="token punctuation">.</span>NodeToStatus<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>scheduleResult<span class="token punctuation">.</span>SuggestedHost<span class="token punctuation">,</span> status<span class="token punctuation">)</span>
            <span class="token keyword">return</span> framework<span class="token punctuation">.</span><span class="token function">NewStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithError</span><span class="token punctuation">(</span>fitErr<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> status
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x5148;&#x5224;&#x65AD;&#x8981;&#x7ED1;&#x5B9A;&#x7684;Pod&#x662F;&#x5426;&#x662F;<code>waitingPod</code>&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x5C31;&#x76F4;&#x63A5;&#x8FDB;&#x5165;&#x540E;&#x9762;&#x7684;&#x6D41;&#x7A0B;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>frameworkImpl<span class="token punctuation">)</span> <span class="token function">WaitOnPermit</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token operator">*</span>framework<span class="token punctuation">.</span>Status <span class="token punctuation">{</span>
    <span class="token comment">// &#x4ECE;waitingPods&#x96C6;&#x5408;&#x4E2D;&#x83B7;&#x53D6;&#x5F53;&#x524D;Pod</span>
    waitingPod <span class="token operator">:=</span> f<span class="token punctuation">.</span>waitingPods<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>UID<span class="token punctuation">)</span>
    <span class="token comment">// &#x96C6;&#x5408;&#x4E2D;&#x4E0D;&#x5B58;&#x5728;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span>
    <span class="token keyword">if</span> waitingPod <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// WaitOnPermit&#x6D41;&#x7A0B;&#x7684;&#x6700;&#x540E;&#x4ECE;waitingPods&#x96C6;&#x5408;&#x4E2D;&#x79FB;&#x9664;&#x5F53;&#x524D;&#x5BF9;&#x8C61;</span>
    <span class="token keyword">defer</span> f<span class="token punctuation">.</span>waitingPods<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>UID<span class="token punctuation">)</span>

    logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Pod waiting on permit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">)</span>

    startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// waitingPod&#x7684;s&#x662F;&#x4E00;&#x4E2A;channel &#x7528;&#x4E8E;&#x63A5;&#x6536;&#x6700;&#x7EC8;&#x7684;Permit&#x7ED3;&#x679C;</span>
    s <span class="token operator">:=</span> <span class="token operator">&lt;-</span>waitingPod<span class="token punctuation">.</span>s
    metrics<span class="token punctuation">.</span>PermitWaitDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInSeconds</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// &#x9519;&#x8BEF;&#x5904;&#x7406;</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">IsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">IsRejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Pod rejected while waiting on permit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> s
        <span class="token punctuation">}</span>
        err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">AsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Failed waiting on permit for pod&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod&quot;</span><span class="token punctuation">,</span> klog<span class="token punctuation">.</span><span class="token function">KObj</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> framework<span class="token punctuation">.</span><span class="token function">AsStatus</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;waiting on permit for pod: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithPlugin</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">Plugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x8C03;&#x5EA6;&#x5468;&#x671F;&#x7684;&#x6807;&#x51C6;&#x903B;&#x8F91;&#x5B8C;&#x5168;&#x7ED3;&#x675F;&#xFF0C;&#x5173;&#x4E8E;&#x5931;&#x8D25;&#x5904;&#x7406;&#x903B;&#x8F91;<code>FailureHandler</code>&#x4F1A;&#x653E;&#x5230;&#x5173;&#x4E8E;<code>Preemption</code>&#x7684;&#x7AE0;&#x8282;&#x91CC;&#x4E00;&#x8D77;&#x8BF4;&#x660E;&#x3002; </p>
<footer class="page-footer"><span class="copyright">&#xA9; 2025 lts0609.  all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x6700;&#x540E;&#x66F4;&#x65B0;&#x65F6;&#x95F4;:
2025-07-29 16:04:37
</span></footer>
<script>console.log("plugin-popup....");document.onclick = function(e){ e.target.tagName === "IMG" && window.open(e.target.src,e.target.src)}</script><style>img{cursor:pointer}</style> <link rel="stylesheet" type="text/css" href="https://storage.googleapis.com/app.klipse.tech/css/codemirror.css"> <script>     window.klipse_settings = {         selector: ".language-klipse, .lang-eval-clojure",         selector_eval_js: ".lang-eval-js",         selector_eval_python_client: ".lang-eval-python",         selector_eval_php: ".lang-eval-php",         selector_eval_scheme: ".lang-eval-scheme",         selector_eval_ruby: ".lang-eval-ruby",         selector_reagent: ".lang-reagent",        selector_google_charts: ".lang-google-chart",        selector_es2017: ".lang-eval-es2017",        selector_jsx: ".lang-eval-jsx",        selector_transpile_jsx: ".lang-transpile-jsx",        selector_render_jsx: ".lang-render-jsx",        selector_react: ".lang-react",        selector_eval_markdown: ".lang-render-markdown",        selector_eval_lambdaway: ".lang-render-lambdaway",        selector_eval_cpp: ".lang-eval-cpp",        selector_eval_html: ".lang-render-html",        selector_sql: ".lang-eval-sql",        selector_brainfuck: "lang-eval-brainfuck",        selector_js: ".lang-transpile-cljs"    }; </script> <script src="https://storage.googleapis.com/app.klipse.tech/plugin/js/klipse_plugin.js"></script>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="04-详解调度周期SchedulingCycle-上.html" class="navigation navigation-prev " aria-label="Previous page: 详解调度周期SchedulingCycle(上)">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="06-详解绑定周期BindingCycle.html" class="navigation navigation-next " aria-label="Next page: 详解绑定周期BindingCycle">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"详解调度周期SchedulingCycle(下)","level":"1.2.5","depth":2,"next":{"title":"详解绑定周期BindingCycle","level":"1.2.6","depth":2,"path":"kube-scheduler/06-详解绑定周期BindingCycle.md","ref":"kube-scheduler/06-详解绑定周期BindingCycle.md","articles":[]},"previous":{"title":"详解调度周期SchedulingCycle(上)","level":"1.2.4","depth":2,"path":"kube-scheduler/04-详解调度周期SchedulingCycle-上.md","ref":"kube-scheduler/04-详解调度周期SchedulingCycle-上.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-highlight","-lunr","-search","-sharing","-sharing-plus","pageview-count","page-treeview","code","chapter-fold","search-pro","popup","scroll-to-top","auto-scroll-table","anchor-navigation-ex","klipse","prism","theme-comscore","tbfed-pagefooter","livereload"],"styles":{"pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css","website":"styles/website.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"© 2025 lts0609. ","modify_label":"最后更新时间:","modify_format":"YYYY-MM-DD HH:mm:ss"},"page-treeview":{"collapsed":false,"copyright":"","minHeaderCount":"2","minHeaderDeep":"2"},"chapter-fold":{},"prism":{"css":["prismjs/themes/prism-okaidia.css"],"lang":{"go":"go","yaml":"yaml","shell":"shell"}},"scroll-to-top":{},"livereload":{},"search-pro":{"multilingual":false,"indexing":{"delay":500,"minLength":2}},"auto-scroll-table":{},"popup":{},"code":{"copyButtons":true},"fontsettings":{"theme":"white","family":"sans","size":2},"anchor-navigation-ex":{"showLevelIcon":false,"mode":"float","pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"showLevel":true,"tocLevel1Icon":"fa fa-cog","tocLevel2Icon":"fa fa-cog","tocLevel3Icon":"fa fa-cog","showGoTop":true,"printLog":false,"multipleH1":false,"multipleH2":false,"associatedWithSummary":true,"multipleH3":false,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"multipleH4":false},"theme-comscore":{},"pageview-count":{},"klipse":{"myConfigKey":"it's the default value","languages":["go","yaml"]},"theme-default":{"styles":{"pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css","website":"styles/website.css"},"showLevel":false}},"theme":"default","author":"lts0609","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Kubernetes Learning","language":"zh-hans","gitbook":"*","description":"Kubernetes源码学习"},"file":{"path":"kube-scheduler/05-详解调度周期SchedulingCycle-下.md","mtime":"2025-07-29T08:04:37.671Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2025-07-29T08:06:21.331Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-pageview-count/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-scroll-to-top/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-auto-scroll-table/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    </body>
</html>

